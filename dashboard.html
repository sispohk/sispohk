<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard E-Rapor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="data.js"></script>

  <style>
    .sidebar-bg { background-color: #1e3a8a; }
    .custom-scroll::-webkit-scrollbar { width: 8px; }
    .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input:focus, textarea:focus { background-color: #eff6ff !important; outline: 2px solid #2563eb; }
    #loading-overlay { background: rgba(255,255,255,0.8); backdrop-filter: blur(2px); }
    
    .std-table th { background-color: #2563eb; color: white; padding: 10px; border: 1px solid #e5e7eb; white-space: nowrap; }
    .std-table td { padding: 8px; border: 1px solid #e5e7eb; vertical-align: middle; }
    .std-table tr:hover { background-color: #f9fafb; }
    .std-table input, .std-table textarea { border: 1px solid #d1d5db; border-radius: 4px; padding: 4px; font-size: 0.875rem; width: 100%; text-align: center;}
    .std-table textarea { text-align: left; }
    
    /* FIX: Nama 1 Baris */
    .single-line { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px; display: block; }
  </style>
</head>
<body class="bg-gray-100 flex h-screen overflow-hidden">

  <aside class="w-64 sidebar-bg text-white flex flex-col shadow-xl flex-shrink-0 transition-all duration-300 relative z-20" id="sidebar">
    <div class="p-6 border-b border-blue-800 flex items-center gap-2">
      <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-blue-900 font-bold text-xl">E</div>
      <h1 class="text-xl font-bold tracking-wide">E-Rapor</h1>
    </div>
    <div class="p-4 bg-blue-800 bg-opacity-50 text-xs border-b border-blue-700">
        <p id="user-info-name" class="font-bold text-sm truncate">Loading...</p>
        <p id="user-info-role" class="text-blue-200 capitalize">...</p>
    </div>
    <nav class="flex-1 overflow-y-auto custom-scroll p-4">
      <ul id="sidebar-menu" class="space-y-1"></ul>
    </nav>
    <div class="p-4 border-t border-blue-700">
        <button onclick="logout()" class="w-full py-2 bg-red-600 hover:bg-red-700 text-white rounded font-bold shadow text-sm transition">Keluar</button>
    </div>
  </aside>

  <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
    <header class="bg-white shadow p-4 flex justify-between items-center md:hidden z-10">
        <h2 class="font-bold text-gray-700">E-Rapor</h2>
        <button onclick="toggleSidebar()" class="text-blue-600 font-bold">‚ò∞ Menu</button>
    </header>
    <div id="main-content" class="flex-1 overflow-auto p-6 relative">
        <div class="flex items-center justify-center h-full"><p class="text-gray-500 animate-pulse">Memuat data...</p></div>
    </div>
    <div id="loading-overlay" class="absolute inset-0 hidden flex flex-col items-center justify-center z-50">
        <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-2 text-blue-800 font-bold" id="loading-text">Memproses...</p>
        <div id="loading-progress-wrap" class="w-72 mt-3 hidden">
            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                <div id="loading-progress-bar" class="bg-blue-600 h-3 rounded-full" style="width:0%"></div>
            </div>
            <p id="loading-progress-text" class="text-xs text-gray-700 mt-1 text-center">0%</p>
        </div>
    
    </div>
  </main>

  <div id="admin-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
      <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
        <h3 id="modal-title" class="text-xl font-bold text-gray-800">Form Data</h3>
        <button onclick="closeModal()" class="text-gray-500 hover:text-red-500 font-bold text-2xl">&times;</button>
      </div>
      <div class="p-6 overflow-y-auto custom-scroll flex-1">
        <input type="hidden" id="edit-id"> 
        <div class="space-y-4">
            <div><label class="block text-sm font-bold">Nama Lengkap</label><input type="text" id="inp-nama" class="w-full border p-2 rounded"></div>
            
                        <div id="form-santri-fields" class="hidden space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-bold">NIS</label>
                        <input type="text" id="inp-nis" class="w-full border p-2 rounded" placeholder="Wajib unik">
                    </div>
                    <div>
                        <label class="block text-sm font-bold">Kelas</label>
                        <input type="text" id="inp-kelas" class="w-full border p-2 rounded" placeholder="10-A">
                    </div>
                    <div>
                        <label class="block text-sm font-bold">JK</label>
                        <select id="inp-jk-santri" class="w-full border p-2 rounded">
                            <option value="">- Pilih -</option>
                            <option value="L">L</option>
                            <option value="P">P</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold">TTL</label>
                        <input type="text" id="inp-ttl" class="w-full border p-2 rounded" placeholder="Kuningan, 12-01-2010">
                    </div>
                    <div>
                        <label class="block text-sm font-bold">Status Keluarga</label>
                        <input type="text" id="inp-status-keluarga" class="w-full border p-2 rounded" placeholder="Anak Kandung / Yatim / Piatu / ...">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-bold">Anak Ke-</label>
                        <input type="number" id="inp-anak-ke" class="w-full border p-2 rounded" placeholder="(boleh kosong)">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold">Asal Sekolah</label>
                        <input type="text" id="inp-asal-sekolah" class="w-full border p-2 rounded">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold">Tanggal Diterima</label>
                        <input type="text" id="inp-tanggal-diterima" class="w-full border p-2 rounded" placeholder="YYYY-MM-DD / DD/MM/YYYY">
                    </div>
                    <div>
                        <label class="block text-sm font-bold">Diterima Kelas</label>
                        <input type="text" id="inp-diterima-kelas" class="w-full border p-2 rounded" placeholder="Kelas awal diterima">
                    </div>
                </div>

                <div class="border p-4 rounded bg-gray-50">
                    <div class="font-bold text-sm mb-3">Data Orang Tua</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold">Nama Ayah</label>
                            <input type="text" id="inp-nama-ayah" class="w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-bold">Pekerjaan Ayah</label>
                            <input type="text" id="inp-pekerjaan-ayah" class="w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-bold">Nama Ibu</label>
                            <input type="text" id="inp-nama-ibu" class="w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-bold">Pekerjaan Ibu</label>
                            <input type="text" id="inp-pekerjaan-ibu" class="w-full border p-2 rounded">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold">Alamat Ortu</label>
                            <input type="text" id="inp-alamat-ortu" class="w-full border p-2 rounded">
                        </div>
                    </div>
                </div>

                <div class="border p-4 rounded bg-gray-50">
                    <div class="font-bold text-sm mb-3">Data Wali</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold">Nama Wali</label>
                            <input type="text" id="inp-nama-wali" class="w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-bold">Pekerjaan Wali</label>
                            <input type="text" id="inp-pekerjaan-wali" class="w-full border p-2 rounded">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold">Alamat Wali</label>
                            <input type="text" id="inp-alamat-wali" class="w-full border p-2 rounded">
                        </div>
                    </div>
                </div>
            </div>

            <div id="form-guru-fields" class="hidden space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-bold">Username</label><input type="text" id="inp-username" class="w-full border p-2 rounded"></div>
                    <div><label class="block text-sm font-bold">Password</label><input type="text" id="inp-password" class="w-full border p-2 rounded" placeholder="Isi untuk ubah"></div>
                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                     <div>
                        <label class="block text-sm font-bold">Role</label>
                        <select id="inp-role" class="w-full border p-2 rounded">
                            <option value="guru">guru</option>
                            <option value="admin">admin</option>
                        </select>
                     </div>
                     <div>
                        <label class="block text-sm font-bold">JK</label>
                        <select id="inp-jk-guru" class="w-full border p-2 rounded">
                            <option value="">- Pilih -</option>
                            <option value="L">L</option>
                            <option value="P">P</option>
                        </select>
                     </div>
                     <div>
                        <label class="block text-sm font-bold">Musyrif (Kelas)</label>
                        <input type="text" id="inp-musyrif" class="w-full border p-2 rounded" placeholder="Contoh: 10-A">
                     </div>
                </div>
                <div><label class="block text-sm font-bold">Wali Kelas</label><input type="text" id="inp-kelas-wali" class="w-full border p-2 rounded" placeholder="Contoh: 10-A"></div>

                <div class="border p-4 rounded bg-gray-50 mt-2">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-bold">Mapel & Kelas Ajar</label>
                        <button onclick="addMapelRow()" class="text-xs bg-green-600 text-white px-2 py-1 rounded shadow">+ Tambah Mapel</button>
                    </div>
                    <div id="mapel-container" class="space-y-3"></div>
                </div>
            </div>
        </div>
      </div>
      <div class="p-4 border-t bg-gray-50 rounded-b-lg flex justify-end gap-2">
        <button onclick="closeModal()" class="px-4 py-2 bg-gray-500 text-white rounded">Batal</button>
        <button onclick="saveData()" class="px-6 py-2 bg-blue-600 text-white rounded font-bold shadow">Simpan</button>
      </div>
    </div>
  </div>

  <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded shadow-lg transform translate-y-20 transition-transform duration-300 flex items-center gap-3 z-50">
    <span id="toast-msg">Notifikasi</span>
  </div>
  <input type="file" id="file-import" class="hidden" accept=".xlsx, .xls">

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const u = getCurrentUser();
        if(!u) { window.location.href = 'index.html'; return; }
        document.getElementById('user-info-name').innerText = u.name;
        document.getElementById('user-info-role').innerText = u.role;
        setLoading(true, "Memuat Data...");
        setLoadingProgress(0, 'Memuat ulang data...');
            await loadInitialData({ onProgress: (pct, label) => setLoadingProgress(pct, label) });
        setLoading(false);
        renderSidebar();
        renderDashboardContent();
    });
    const isGuru = u => (u?.role || '').toLowerCase().includes('guru') || (u?.mapel && parseMapelData(u.mapel).length > 0);
    // isAdmin, isWali, getWaliKelas sudah didefinisikan di data.js (hindari duplicate declaration)

    function renderSidebar() {
        const u = getCurrentUser();
        const menu = document.getElementById('sidebar-menu');
        menu.innerHTML = `<li><a href="#" onclick="renderDashboardContent()" class="flex items-center gap-3 p-3 rounded hover:bg-blue-700 font-bold text-sm">üè† Dashboard</a></li>`;

        if (isAdmin(u)) {
            menu.innerHTML += `
            <li class="px-3 mt-6 mb-2 text-xs text-blue-300 uppercase font-bold tracking-wider">Administrator</li>
            <li><a href="#" onclick="renderAdminGuru()" class="block p-2 rounded hover:bg-blue-700 text-sm pl-4">üë• Data Guru</a></li>
            <li><a href="#" onclick="renderAdminSantri()" class="block p-2 rounded hover:bg-blue-700 text-sm pl-4">üéì Data Santri</a></li>
            <li><a href="#" onclick="renderBobotNilai()" class="block p-2 rounded hover:bg-blue-700 text-sm pl-4">‚öñÔ∏è Bobot Nilai</a></li>
            <li><a href="#" onclick="renderKonversiNilai()" class="block p-2 rounded hover:bg-blue-700 text-sm pl-4">üîÑ Konversi Nilai</a></li>`;
        }
        
        if (isGuru(u)) {
            const mapelList = parseMapelData(u.mapel);
            if (mapelList.length > 0) {
                menu.innerHTML += `<li class="px-3 mt-6 mb-2 text-xs text-blue-300 uppercase font-bold tracking-wider">Guru Mapel</li>`;
                mapelList.forEach((m, idx) => {
                    const collapseId = `sub-mapel-${idx}`;
                    const kelasLinks = m.kelas.length > 0 ? m.kelas.map(cls => 
                        `<li><a href="#" onclick="renderNilaiPage('${m.nama}', '${cls}')" class="block p-2 pl-8 hover:bg-blue-800 text-sm text-gray-200">${cls}</a></li>`
                    ).join('') : `<li><span class="text-xs text-gray-400 pl-8 block py-1">Belum ada kelas</span></li>`;
                    menu.innerHTML += `
                    <li class="mb-1">
                        <div onclick="document.getElementById('${collapseId}').classList.toggle('hidden')" class="flex justify-between items-center cursor-pointer p-2 rounded hover:bg-blue-700 text-sm font-semibold pl-4">
                            <span>üìò ${m.nama}</span><span class="text-xs">‚ñº</span>
                        </div>
                        <ul id="${collapseId}" class="hidden mt-1 bg-blue-900 bg-opacity-40 rounded mb-2">${kelasLinks}</ul>
                    </li>`;
                });

                // Menu KONVERSI NILAI (isi sama seperti Guru Mapel)
                menu.innerHTML += `<li class="px-3 mt-6 mb-2 text-xs text-blue-300 uppercase font-bold tracking-wider">Konversi Nilai</li>`;
                mapelList.forEach((m, idx) => {
                    const collapseId = `sub-konv-${idx}`;
                    const kelasLinks = m.kelas.length > 0 ? m.kelas.map(cls =>
                        `<li><a href="#" onclick="renderKonversiMapelPage('${m.nama}', '${cls}')" class="block p-2 pl-8 hover:bg-blue-800 text-sm text-gray-200">${cls}</a></li>`
                    ).join('') : `<li><span class="text-xs text-gray-400 pl-8 block py-1">Belum ada kelas</span></li>`;
                    menu.innerHTML += `
                    <li class="mb-1">
                        <div onclick="document.getElementById('${collapseId}').classList.toggle('hidden')" class="flex justify-between items-center cursor-pointer p-2 rounded hover:bg-blue-700 text-sm font-semibold pl-4">
                            <span>üîÑ ${m.nama}</span><span class="text-xs">‚ñº</span>
                        </div>
                        <ul id="${collapseId}" class="hidden mt-1 bg-blue-900 bg-opacity-40 rounded mb-2">${kelasLinks}</ul>
                    </li>`;
                });

            }
        }

        if (u.musyrif) {
            menu.innerHTML += `
            <li class="px-3 mt-6 mb-2 text-xs text-blue-300 uppercase font-bold tracking-wider">Musyrif</li>
            <li><a href="#" onclick="renderMusyrifPage()" class="block p-2 rounded hover:bg-blue-700 text-sm pl-4">üïå ${u.musyrif}</a></li>`;
        }

        if (isWali(u)) {
            const kelasWali = getWaliKelas(u);
            menu.innerHTML += `
            <li class="px-3 mt-6 mb-2 text-xs text-blue-300 uppercase font-bold tracking-wider">Wali Kelas</li>
            <li><a href="#" onclick="renderWaliPage('data')" class="block p-2 rounded hover:bg-blue-700 text-sm pl-4">üìã Data Kelas</a></li>
            <li><a href="#" onclick="renderWaliPage('absen')" class="block p-2 rounded hover:bg-blue-700 text-sm pl-4">üìÖ Absensi & Sikap</a></li>
            <li><a href="#" onclick="renderWaliPage('catatan')" class="block p-2 rounded hover:bg-blue-700 text-sm pl-4">üìù Catatan & Prestasi</a></li>
            <li><a href="#" onclick="renderWaliPage('print')" class="block p-2 rounded hover:bg-blue-700 text-sm pl-4">üñ®Ô∏è Raport & Legger</a></li>`;
        }
    }

        function renderDashboardContent() {
        const u = getCurrentUser();

        // Admin dashboard: ringkasan statistik
        if (isAdmin(u)) {
            const totalGuru = users.length;
            const totalSantri = students.length;
            const totalWali = users.filter(x => (x.wali || x.kelas_wali || '').toString().trim() !== '').length;
            const totalMusyrif = users.filter(x => (x.musyrif || '').toString().trim() !== '').length;

            // hitung mapel unik
            const mapelSet = new Set();
            users.forEach(g => {
                const m = parseMapelData(g.mapel);
                m.forEach(x => { if (x?.nama) mapelSet.add(String(x.nama).toUpperCase().trim()); });
            });

            document.getElementById('main-content').innerHTML = `
            <div class="max-w-6xl mx-auto space-y-6">
                <div class="bg-white p-8 rounded-xl shadow border-l-8 border-blue-600">
                    <h2 class="text-3xl font-extrabold text-gray-800 mb-2">Selamat Datang, Administrator</h2>
                    <div class="flex flex-wrap gap-2 items-center">
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-bold uppercase">admin</span>
                        <span class="text-xs text-gray-500">Terakhir refresh: ${new Date().toLocaleString('id-ID')}</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                    <div class="bg-white p-5 rounded-xl shadow border">
                        <div class="text-sm text-gray-500 font-bold mb-1">Total Guru</div>
                        <div class="text-3xl font-extrabold text-gray-800">${totalGuru}</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow border">
                        <div class="text-sm text-gray-500 font-bold mb-1">Total Santri</div>
                        <div class="text-3xl font-extrabold text-gray-800">${totalSantri}</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow border">
                        <div class="text-sm text-gray-500 font-bold mb-1">Wali Kelas Aktif</div>
                        <div class="text-3xl font-extrabold text-gray-800">${totalWali}</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow border">
                        <div class="text-sm text-gray-500 font-bold mb-1">Musyrif Aktif</div>
                        <div class="text-3xl font-extrabold text-gray-800">${totalMusyrif}</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow border">
                        <div class="text-sm text-gray-500 font-bold mb-1">Mapel Unik</div>
                        <div class="text-3xl font-extrabold text-gray-800">${mapelSet.size}</div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow border">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Catatan Singkat</h3>
                    <ul class="list-disc pl-6 text-sm text-gray-700 space-y-1">
                        <li>Role akun hanya: <b>admin</b> dan <b>guru</b>. Peran wali kelas/musyrif otomatis aktif kalau kolom <b>wali</b> / <b>musyrif</b> terisi.</li>
                        <li>Menu <b>Data Santri</b> kini menampilkan semua kolom sesuai tabel <b>public.santri</b> (import/export juga sama).</li>
                    </ul>
                </div>
            </div>`;
            return;
        }

        // Guru dashboard (default)
        document.getElementById('main-content').innerHTML = `
        <div class="max-w-4xl mx-auto space-y-6">
            <div class="bg-white p-8 rounded-xl shadow border-l-8 border-blue-600">
                <h2 class="text-3xl font-extrabold text-gray-800 mb-2">Selamat Datang, ${u.name}</h2>
                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-bold uppercase">${u.role}</span>
            </div>
        </div>`;
    }

    // --- ADMIN: GURU (FIX: 1 Baris Nama, JK) ---
        function renderAdminGuru() {
        const main = document.getElementById('main-content');
        const sourceData = window.tempImportDataGuru || users;

        const rows = sourceData.map((u, i) => {
            const canEdit = !!u.id && !window.tempImportDataGuru;
            const waliVal = (u.wali || u.kelas_wali || '-');
            return `
            <tr class="hover:bg-gray-50 border-b">
                <td class="p-2 text-center">${i + 1}</td>
                <td class="p-2 text-left font-bold filter-target"><div class="single-line w-64" title="${u.name}">${u.name}</div></td>
                <td class="p-2 font-mono text-xs">${u.username}</td>
                <td class="p-2 text-center text-xs uppercase">${(u.role||'guru')}</td>
                <td class="p-2 text-center text-sm">${u.jk||u.lp||'-'}</td>
                <td class="p-2 text-left text-xs">${parseMapelData(u.mapel).map(m=>`<div class="mb-1"><span class="bg-blue-100 font-bold px-1 rounded mr-1">${m.nama}</span>: ${m.kelas.join(', ')}</div>`).join('')}</td>
                <td class="p-2 text-center">${waliVal}</td>
                <td class="p-2 text-center">${u.musyrif||'-'}</td>
                <td class="p-2 text-center">
                    <button ${canEdit ? `onclick="editGuru(${u.id})"` : 'disabled'} class="${canEdit ? 'text-blue-600 hover:bg-blue-100' : 'text-gray-400 cursor-not-allowed'} font-bold text-xs p-1 rounded">Edit</button>
                </td>
            </tr>`;
        }).join('');

        const headerBtn = `
        <div class="flex flex-wrap gap-2 justify-end">
            <button onclick="triggerImport('guru')" class="bg-green-600 text-white px-4 py-2 rounded font-bold shadow text-sm">Import</button>
            <button onclick="downloadExcelGuru()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold shadow text-sm">Export</button>
            <button onclick="saveAdminImport('guru')" class="bg-blue-800 text-white px-4 py-2 rounded font-bold shadow text-sm">Simpan</button>
            <button onclick="openModal('guru')" class="bg-gray-700 text-white px-4 py-2 rounded font-bold shadow text-sm">Tambah</button>
        </div>`;

        main.innerHTML = `
        <div class="bg-white p-6 rounded shadow">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-3 mb-4">
                <h2 class="text-2xl font-bold">Data Guru</h2>
                ${headerBtn}
            </div>
            <input type="text" onkeyup="filterTable('tbody-guru')" placeholder="Cari Guru..." class="w-full border p-2 mb-4 rounded">
            <div class="overflow-auto">
                <table class="min-w-[1100px] w-full text-sm border std-table">
                    <thead class="bg-blue-600 text-white">
                        <tr>
                            <th>No</th><th class="text-left w-64">Nama</th><th>User</th><th>Role</th><th>JK</th>
                            <th class="text-left w-1/3">Mapel & Kelas</th><th>Wali</th><th>Musyrif</th><th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-guru">${rows}</tbody>
                </table>
            </div>
        </div>`;
    }


    // --- ADMIN: SANTRI (FIX: 1 Baris Nama, JK) ---
        function renderAdminSantri() {
        const main = document.getElementById('main-content');
        const sourceData = window.tempImportDataSantri || students;

        const rows = sourceData.map((s, i) => {
            const canEdit = !!s.id && !window.tempImportDataSantri;
            return `
            <tr class="hover:bg-gray-50 border-b">
                <td class="p-2 text-center">${i + 1}</td>
                <td class="p-2 text-center font-mono">${s.nis||'-'}</td>
                <td class="p-2 text-left font-bold filter-target"><div class="single-line w-64" title="${s.name||''}">${s.name||'-'}</div></td>
                <td class="p-2 text-center">${s.jk||s.lp||'-'}</td>
                <td class="p-2 text-center">${s.kelas||'-'}</td>
                <td class="p-2 text-left"><div class="single-line w-56" title="${s.ttl||''}">${s.ttl||'-'}</div></td>
                <td class="p-2 text-left"><div class="single-line w-40" title="${s.status_keluarga||''}">${s.status_keluarga||'-'}</div></td>
                <td class="p-2 text-center">${(s.anak_ke ?? '-') }</td>
                <td class="p-2 text-left"><div class="single-line w-56" title="${s.asal_sekolah||''}">${s.asal_sekolah||'-'}</div></td>
                <td class="p-2 text-center">${s.tanggal_diterima||'-'}</td>
                <td class="p-2 text-center">${s.diterima_kelas||'-'}</td>
                <td class="p-2 text-left"><div class="single-line w-44" title="${s.nama_ayah||''}">${s.nama_ayah||'-'}</div></td>
                <td class="p-2 text-left"><div class="single-line w-44" title="${s.nama_ibu||''}">${s.nama_ibu||'-'}</div></td>
                <td class="p-2 text-left"><div class="single-line w-44" title="${s.pekerjaan_ayah||''}">${s.pekerjaan_ayah||'-'}</div></td>
                <td class="p-2 text-left"><div class="single-line w-44" title="${s.pekerjaan_ibu||''}">${s.pekerjaan_ibu||'-'}</div></td>
                <td class="p-2 text-left"><div class="single-line w-72" title="${s.alamat_ortu||''}">${s.alamat_ortu||'-'}</div></td>
                <td class="p-2 text-left"><div class="single-line w-44" title="${s.nama_wali||''}">${s.nama_wali||'-'}</div></td>
                <td class="p-2 text-left"><div class="single-line w-44" title="${s.pekerjaan_wali||''}">${s.pekerjaan_wali||'-'}</div></td>
                <td class="p-2 text-left"><div class="single-line w-72" title="${s.alamat_wali||''}">${s.alamat_wali||'-'}</div></td>
                <td class="p-2 text-center">
                    <button ${canEdit ? `onclick="editSantri(${s.id})"` : 'disabled'} class="${canEdit ? 'text-blue-600 hover:bg-blue-100' : 'text-gray-400 cursor-not-allowed'} font-bold text-xs p-1 rounded">Edit</button>
                </td>
            </tr>`;
        }).join('');

        const headerBtn = `
        <div class="flex flex-wrap gap-2 justify-end">
            <button onclick="triggerImport('santri')" class="bg-green-600 text-white px-4 py-2 rounded font-bold shadow text-sm">Import</button>
            <button onclick="downloadExcelSantri()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold shadow text-sm">Export</button>
            <button onclick="saveAdminImport('santri')" class="bg-blue-800 text-white px-4 py-2 rounded font-bold shadow text-sm">Simpan</button>
            <button onclick="openModal('santri')" class="bg-gray-700 text-white px-4 py-2 rounded font-bold shadow text-sm">Tambah</button>
        </div>`;

        main.innerHTML = `
        <div class="bg-white p-6 rounded shadow">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-3 mb-4">
                <h2 class="text-2xl font-bold">Data Santri</h2>
                ${headerBtn}
            </div>
            <input type="text" onkeyup="filterTable('tbody-santri')" placeholder="Cari Santri..." class="w-full border p-2 mb-4 rounded">
            <div class="overflow-auto max-h-[70vh]">
                <table class="min-w-[1700px] w-full text-xs border std-table whitespace-nowrap">
                    <thead class="bg-blue-600 text-white sticky top-0">
                        <tr>
                            <th>No</th><th>NIS</th><th class="text-left">Nama</th><th>JK</th><th>Kelas</th>
                            <th class="text-left">TTL</th><th class="text-left">Status Keluarga</th><th>Anak Ke</th><th class="text-left">Asal Sekolah</th>
                            <th>Tgl Diterima</th><th>Diterima Kelas</th>
                            <th class="text-left">Nama Ayah</th><th class="text-left">Nama Ibu</th>
                            <th class="text-left">Pekerjaan Ayah</th><th class="text-left">Pekerjaan Ibu</th>
                            <th class="text-left">Alamat Ortu</th>
                            <th class="text-left">Nama Wali</th><th class="text-left">Pekerjaan Wali</th><th class="text-left">Alamat Wali</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-santri">${rows}</tbody>
                </table>
            </div>
        </div>`;
    }


    // --- FITUR ADMIN ---
    async function renderBobotNilai() {
        try {
            setLoading(true, "Memuat Bobot Nilai...");
            const b = await fetchBobotNilaiGlobal();

            const vKeh = Number(b.bobot_kehadiran ?? b.kehadiran ?? 10) || 0;
            const vTgs = Number(b.bobot_tugas ?? b.tugas ?? 20) || 0;
            const vUH  = Number(b.bobot_uh ?? b.uh ?? 40) || 0;
            const vPAS = Number(b.bobot_paspat ?? b.bobot_pas_pat ?? b.pas_pat ?? b.pas ?? 30) || 0;

            const card = (title, id, val, color) => `
                <div class="border rounded-xl p-6 ${color} shadow-sm hover:shadow-md transition text-center">
                    <h4 class="font-bold text-gray-700 text-lg mb-2">${title}</h4>
                    <div class="flex justify-center items-end gap-1">
                        <input id="${id}" type="number" value="${val}" min="0" max="100"
                            class="text-4xl font-bold bg-transparent border-b-2 border-gray-400 focus:border-blue-600 w-24 text-center outline-none">
                        <span class="text-xl font-bold text-gray-500 mb-2">%</span>
                    </div>
                </div>`;

            document.getElementById('main-content').innerHTML = `
            <div class="bg-white p-8 rounded-lg shadow-lg border-t-4 border-yellow-500 max-w-5xl mx-auto">
                <h2 class="text-3xl font-bold mb-2 text-gray-800">‚öñÔ∏è Pengaturan Bobot Nilai</h2>
                <p class="text-sm text-gray-600 mb-6">Komponen: <b>Kehadiran</b>, <b>Tugas</b>, <b>UH (rata-rata UH1..UH5)</b>, <b>PAS/PAT</b>. Total harus <b>100%</b>.</p>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    ${card('Kehadiran', 'bobot-kehadiran', vKeh, 'bg-red-50')}
                    ${card('Tugas', 'bobot-tugas', vTgs, 'bg-yellow-50')}
                    ${card('UH', 'bobot-uh', vUH, 'bg-green-50')}
                    ${card('PAS/PAT', 'bobot-pas', vPAS, 'bg-blue-50')}
                </div>

                <div class="mt-8 flex flex-wrap gap-2 justify-end">
                    <button onclick="renderBobotNilai()" class="bg-gray-200 text-gray-800 px-6 py-3 rounded font-bold hover:bg-gray-300">Refresh</button>
                    <button onclick="saveBobotNilaiUI()" class="bg-yellow-600 text-white px-8 py-3 rounded font-bold hover:bg-yellow-700">Simpan</button>
                </div>
            </div>`;
        } catch (e) {
            console.error(e);
            showToast('Gagal memuat bobot: ' + (e.message || e), 'error');
        } finally {
            setLoading(false);
        }
    }

    async function saveBobotNilaiUI() {
        try {
            const bobot_kehadiran = Number(document.getElementById('bobot-kehadiran')?.value || 0);
            const bobot_tugas = Number(document.getElementById('bobot-tugas')?.value || 0);
            const bobot_uh = Number(document.getElementById('bobot-uh')?.value || 0);
            const bobot_paspat = Number(document.getElementById('bobot-pas')?.value || 0);

            setLoading(true, "Menyimpan Bobot Nilai...");
            await saveBobotNilaiGlobal({ bobot_kehadiran, bobot_tugas, bobot_uh, bobot_paspat });

            showToast('Bobot tersimpan', 'success');
        } catch (e) {
            console.error(e);
            showToast('Gagal simpan bobot: ' + (e.message || e), 'error');
        } finally {
            setLoading(false);
        }
    }

    async function renderKonversiNilai() {
        const cols = [
            { jenjang: 'X', semester: 1, label: 'X ‚Ä¢ Sem 1' },
            { jenjang: 'X', semester: 2, label: 'X ‚Ä¢ Sem 2' },
            { jenjang: 'XI', semester: 1, label: 'XI ‚Ä¢ Sem 1' },
            { jenjang: 'XI', semester: 2, label: 'XI ‚Ä¢ Sem 2' },
            { jenjang: 'XII', semester: 1, label: 'XII ‚Ä¢ Sem 1' },
            { jenjang: 'XII', semester: 2, label: 'XII ‚Ä¢ Sem 2' },
        ];

        try {
            setLoading(true, "Memuat Konversi Ideal...");
            const map = await fetchKonversiIdealMatrixGlobal();

            const getVal = (jenjang, semester, field, defVal) => {
                const r = map.get(`${jenjang}|${semester}`);
                if (!r) return defVal;
                return Number(r[field] ?? defVal) || defVal;
            };

            const makeRow = (label, field, defaults) => `
              <tr>
                <td class="p-2 border font-bold bg-gray-50 text-left">${label}</td>
                ${cols.map((c, idx) => `
                  <td class="border p-1">
                    <input type="number"
                      data-jenjang="${c.jenjang}"
                      data-semester="${c.semester}"
                      data-field="${field}"
                      value="${getVal(c.jenjang, c.semester, field, defaults[idx])}"
                      class="w-full text-center p-1 border rounded">
                  </td>
                `).join('')}
              </tr>
            `;

            // default sesuai yang kamu tetapkan (6 opsi/preset)
            const minDef = [76,77,78,79,80,81];
            const maxDef = [94,95,96,97,98,99];
            const meanDef = [81,82,83,84,85,86];

            document.getElementById('main-content').innerHTML = `
            <div class="bg-white p-6 rounded shadow">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
                    <div>
                        <h2 class="text-2xl font-bold">üîÑ Konversi Nilai (Ideal)</h2>
                        <p class="text-sm text-gray-600">Ini adalah <b>nilai ideal</b> yang dipakai rumus katrol untuk menghasilkan <b>Nilai Konversi</b>.</p>
                    </div>
                    <div class="flex gap-2 justify-end">
                        <button onclick="renderKonversiNilai()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded font-bold hover:bg-gray-300">Refresh</button>
                        <button onclick="saveKonversiNilaiUI()" class="bg-blue-800 text-white px-6 py-2 rounded font-bold">Simpan</button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                <table class="w-full border text-sm text-center std-table">
                    <thead class="bg-blue-600 text-white">
                        <tr><th rowspan="2" class="p-2 border">Ket</th><th colspan="2" class="border">Kelas X</th><th colspan="2" class="border">Kelas XI</th><th colspan="2" class="border">Kelas XII</th></tr>
                        <tr><th>Sem 1</th><th>Sem 2</th><th>Sem 1</th><th>Sem 2</th><th>Sem 1</th><th>Sem 2</th></tr>
                    </thead>
                    <tbody id="konv-ideal-body">
                        ${makeRow('Nilai Minimum (Min Ideal)', 'min_ideal', minDef)}
                        ${makeRow('Nilai Maksimum (Max Ideal)', 'max_ideal', maxDef)}
                        ${makeRow('Nilai Rata-rata (Rerata Ideal)', 'mean_ideal', meanDef)}
                    </tbody>
                </table>
                </div>
            </div>`;
        } catch (e) {
            console.error(e);
            showToast('Gagal memuat konversi: ' + (e.message || e), 'error');
        } finally {
            setLoading(false);
        }
    }

    async function saveKonversiNilaiUI() {
        try {
            const inputs = Array.from(document.querySelectorAll('#konv-ideal-body input'));
            const rowsMap = new Map(); // key jenjang|semester -> row

            for (const inp of inputs) {
                const jenjang = inp.dataset.jenjang;
                const semester = Number(inp.dataset.semester);
                const field = inp.dataset.field;
                const val = Number(inp.value || 0);

                const key = `${jenjang}|${semester}`;
                if (!rowsMap.has(key)) rowsMap.set(key, { jenjang, semester, min_ideal: 0, max_ideal: 0, mean_ideal: 0 });
                rowsMap.get(key)[field] = val;
            }

            const rows = Array.from(rowsMap.values());
            // Validasi sederhana
            for (const r of rows) {
                if (r.min_ideal > r.mean_ideal || r.mean_ideal > r.max_ideal) {
                    throw new Error(`Range ideal tidak valid untuk ${r.jenjang} sem ${r.semester}`);
                }
            }

            setLoading(true, "Menyimpan Konversi Ideal...");
            await saveKonversiIdealGlobal(rows);

            showToast('Konversi ideal tersimpan', 'success');
        } catch (e) {
            console.error(e);
            showToast('Gagal simpan konversi: ' + (e.message || e), 'error');
        } finally {
            setLoading(false);
        }
    }

    // --- GURU MAPEL (NILAI) (FIX: Width Nama) ---
    function renderNilaiPage(mapel, kelas) {
        const siswa = students.filter(s => s.kelas === kelas);
        const main = document.getElementById('main-content');
        if(siswa.length === 0) { main.innerHTML = `<div class="p-6 bg-white shadow rounded">Data santri kosong untuk kelas ${kelas}</div>`; return; }

        const rows = siswa.map((s, i) => {
            const { tahun_ajar, semester } = getActivePeriode();
            const sc = scores.find(x => String(x.nis) === String(s.nis) && x.mapel === mapel && String(x.tahun_ajar)===String(tahun_ajar) && Number(x.semester)===Number(semester)) || {};
            return `
            <tr class="hover:bg-gray-50 border-b">
                <td class="p-2 text-center text-gray-500">${i+1}</td>
                <td class="p-2 text-center text-sm font-mono">${s.nis||'-'}</td>
                <td class="p-2 font-medium text-left filter-target"><div class="single-line" title="${s.name}" data-name="${s.name}">${s.name}</div></td>
                <td class="p-2"><input type="number" data-name="${s.name}" data-nis="${s.nis||''}" data-field="kehadiran" value="${sc.kehadiran||0}" class="nav-input"></td>
                <td class="p-2"><input type="number" data-name="${s.name}" data-nis="${s.nis||''}" data-field="uh1" value="${sc.uh1||0}" class="nav-input"></td>
                <td class="p-2"><input type="number" data-name="${s.name}" data-nis="${s.nis||''}" data-field="uh2" value="${sc.uh2||0}" class="nav-input"></td>
                <td class="p-2"><input type="number" data-name="${s.name}" data-nis="${s.nis||''}" data-field="uh3" value="${sc.uh3||0}" class="nav-input"></td>
                <td class="p-2"><input type="number" data-name="${s.name}" data-nis="${s.nis||''}" data-field="uh4" value="${sc.uh4||0}" class="nav-input"></td>
                <td class="p-2"><input type="number" data-name="${s.name}" data-nis="${s.nis||''}" data-field="uh5" value="${sc.uh5||0}" class="nav-input"></td>
                <td class="p-2"><input type="number" data-name="${s.name}" data-nis="${s.nis||''}" data-field="tugas" value="${sc.tugas||0}" class="bg-yellow-50 nav-input"></td>
                <td class="p-2"><input type="number" data-name="${s.name}" data-nis="${s.nis||''}" data-field="pas_pat" value="${sc.pas_pat||sc.pas||0}" class="bg-blue-50 nav-input"></td>
            </tr>`;
        }).join('');

        main.innerHTML = `
        <div class="bg-white p-6 rounded shadow">
            <div class="flex justify-between items-center mb-4">
                <div><h2 class="text-2xl font-bold">${mapel} - ${kelas}</h2></div>
                <div class="flex gap-2">
                    <button onclick="triggerImport('mapel', '${mapel}', '${kelas}')" class="bg-green-600 text-white px-4 py-2 rounded text-sm font-bold shadow">Import</button>
                    <button onclick="exportExcelNilai('${mapel}', '${kelas}')" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold shadow">Export</button>
                    <button onclick="saveNilaiMapel('${mapel}', '${kelas}')" class="bg-blue-800 text-white px-6 py-2 rounded font-bold shadow">Simpan</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm border std-table" id="table-nilai">
                    <thead class="bg-blue-600 text-white">
                        <tr>
                            <th class="p-2">No</th><th class="p-2">NIS</th><th class="p-2 text-left w-64">Nama</th>
                            <th class="p-2 w-14">Hadir</th><th class="p-2 w-14">UH1</th><th class="p-2 w-14">UH2</th><th class="p-2 w-14">UH3</th><th class="p-2 w-14">UH4</th><th class="p-2 w-14">UH5</th>
                            <th class="p-2 w-14 bg-yellow-600 text-white">Tugas</th><th class="p-2 w-20 bg-blue-800 text-white">PAS/PAT</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-nilai">${rows}</tbody>
                </table>
            </div>
        </div>`;
        
    // --- GURU MAPEL: KONVERSI NILAI ---
    function _inferJenjangFromKelas(kelas) {
        const t = (kelas || '').trim().split(/\s+/)[0] || '';
        const up = t.toUpperCase();
        if (up === 'X' || up === 'XI' || up === 'XII') return up;
        // fallback kalau format numeric (10/11/12)
        if (t === '10') return 'X';
        if (t === '11') return 'XI';
        if (t === '12') return 'XII';
        return null;
    }

    function _avgUH(sc) {
        const vals = [sc.uh1, sc.uh2, sc.uh3, sc.uh4, sc.uh5].map(v => Number(v) || 0).filter(v => v > 0);
        if (!vals.length) return 0;
        return vals.reduce((a,b)=>a+b,0) / vals.length;
    }

    function _calcNilaiRapor(sc, bobot) {
        const keh = Number(sc.kehadiran) || 0;
        const tgs = Number(sc.tugas) || 0;
        const uhAvg = _avgUH(sc);
        const pas = Number(sc.pas ?? sc.pas_pat ?? sc.pas_pat) || 0;

        const bKeh = Number(bobot?.bobot_kehadiran ?? 10) || 0;
        const bTgs = Number(bobot?.bobot_tugas ?? 20) || 0;
        const bUH  = Number(bobot?.bobot_uh ?? 40) || 0;
        const bPAS = Number(bobot?.bobot_paspat ?? bobot?.bobot_pas_pat ?? 30) || 0;

        const total = (keh * bKeh + tgs * bTgs + uhAvg * bUH + pas * bPAS) / 100;
        // pembulatan 2 desimal biar enak dibaca
        return Math.round(total * 100) / 100;
    }

    function _clamp(v, min, max) {
        if (v < min) return min;
        if (v > max) return max;
        return v;
    }

    // cache hasil terakhir agar bisa diexport
    window._lastKonversiRows = [];

    async function renderKonversiMapelPage(mapel, kelas) {
        const main = document.getElementById('main-content');
        const siswa = students.filter(s => s.kelas === kelas);

        if (siswa.length === 0) {
            main.innerHTML = `<div class="p-6 bg-white shadow rounded">Data santri kosong untuk kelas ${kelas}</div>`;
            return;
        }

        try {
            setLoading(true, "Menghitung Konversi Nilai...");
            await fetchAppConfig();
            const bobot = await fetchBobotNilaiGlobal();

            const { tahun_ajar, semester } = getActivePeriode();
            const jenjang = _inferJenjangFromKelas(kelas) || 'X';
            const ideal = await fetchKonversiIdeal(jenjang, semester, tahun_ajar);

            if (!ideal) {
                showToast(`Konversi ideal belum di-set untuk ${jenjang} sem ${semester}. Set dulu di Admin > Konversi Nilai.`, 'error');
            }

            const minIdeal = Number(ideal?.min_ideal ?? 0) || 0;
            const maxIdeal = Number(ideal?.max_ideal ?? 100) || 100;
            const meanIdeal = Number(ideal?.mean_ideal ?? 0) || 0;

            // hitung nilai rapor per santri
            const data = siswa.map(s => {
                const sc = scores.find(x =>
                    String(x.nis) === String(s.nis) &&
                    String(x.mapel) === String(mapel) &&
                    String(x.tahun_ajar) === String(tahun_ajar) &&
                    Number(x.semester) === Number(semester)
                ) || {};
                const nilaiRapor = _calcNilaiRapor(sc, bobot);
                return {
                    nis: s.nis,
                    nama: s.name,
                    jk: s.jk || s.lp || '-',
                    nilai_rapor: nilaiRapor,
                };
            });

            // statistik asli (min/max/mean) ‚Äî hanya dari santri yang sudah terisi nilai (bukan 0 semua)
            const valid = data
                .map(d => d.nilai_rapor)
                .filter(v => typeof v === 'number' && Number.isFinite(v) && v > 0);

            const minAsli = valid.length ? Math.min(...valid) : 0;
            const maxAsli = valid.length ? Math.max(...valid) : 0;
            const meanAsli = valid.length ? (valid.reduce((a,b)=>a+b,0) / valid.length) : 0;

            // hitung konversi per santri
            const denom = (maxAsli - minAsli);
            data.forEach(d => {
                let conv = meanIdeal;
                if (denom > 0) {
                    conv = meanIdeal + (d.nilai_rapor - meanAsli) * (maxIdeal - minIdeal) / denom;
                }
                conv = _clamp(conv, minIdeal, maxIdeal);
                d.nilai_konversi = Math.round(conv * 100) / 100;
            });

            window._lastKonversiRows = data;

            const rowsHtml = data.map((d, i) => `
              <tr class="hover:bg-gray-50 border-b">
                <td class="p-2 text-center text-gray-500">${i+1}</td>
                <td class="p-2 text-center font-mono">${d.nis||'-'}</td>
                <td class="p-2 text-left font-medium filter-target"><div class="single-line" title="${d.nama||''}">${d.nama||'-'}</div></td>
                <td class="p-2 text-center">${d.jk||'-'}</td>
                <td class="p-2 text-center font-bold">${d.nilai_rapor ?? '-'}</td>
                <td class="p-2 text-center font-bold">${d.nilai_konversi ?? '-'}</td>
              </tr>
            `).join('');

            main.innerHTML = `
            <div class="bg-white p-6 rounded shadow">
                <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-3 mb-4">
                    <div>
                        <h2 class="text-2xl font-bold">üîÑ Konversi Nilai ‚Ä¢ ${mapel} ‚Ä¢ ${kelas}</h2>
                        <div class="text-xs text-gray-600 mt-1">
                            Periode: <b>${tahun_ajar}</b> ‚Ä¢ Semester: <b>${semester}</b> ‚Ä¢ Jenjang: <b>${jenjang}</b>
                        </div>
                        <div class="mt-2 flex flex-wrap gap-2 text-xs">
                            <span class="px-3 py-1 rounded-full bg-gray-100">Asli: min <b>${minAsli.toFixed(2)}</b> ‚Ä¢ max <b>${maxAsli.toFixed(2)}</b> ‚Ä¢ mean <b>${meanAsli.toFixed(2)}</b></span>
                            <span class="px-3 py-1 rounded-full bg-blue-50">Ideal: min <b>${minIdeal}</b> ‚Ä¢ max <b>${maxIdeal}</b> ‚Ä¢ mean <b>${meanIdeal}</b></span>
                        </div>
                    </div>
                    <div class="flex gap-2 justify-end">
                        <button onclick="renderKonversiMapelPage('${mapel}','${kelas}')" class="bg-gray-200 text-gray-800 px-4 py-2 rounded text-sm font-bold hover:bg-gray-300">Refresh</button>
                        <button onclick="exportExcelKonversi('${mapel}','${kelas}')" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold shadow">Export</button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm border std-table" id="table-konversi">
                        <thead class="bg-blue-600 text-white">
                            <tr>
                                <th class="p-2">No</th>
                                <th class="p-2">NIS</th>
                                <th class="p-2 text-left w-64">Nama</th>
                                <th class="p-2">L/P</th>
                                <th class="p-2">Nilai Rapot</th>
                                <th class="p-2">Nilai Konversi</th>
                            </tr>
                        </thead>
                        <tbody>${rowsHtml}</tbody>
                    </table>
                </div>
            </div>`;
        } catch (e) {
            console.error(e);
            showToast('Gagal menghitung konversi: ' + (e.message || e), 'error');
        } finally {
            setLoading(false);
        }
    }

    // FIX: fungsi dipanggil dari atribut onclick (butuh scope global)
    window.renderKonversiMapelPage = renderKonversiMapelPage;

    function exportExcelKonversi(mapel, kelas) {
        try {
            const rows = (window._lastKonversiRows || []).map((r, idx) => ({
                No: idx + 1,
                NIS: r.nis,
                Nama: r.nama,
                "L/P": r.jk,
                "Nilai Rapot": r.nilai_rapor,
                "Nilai Konversi": r.nilai_konversi,
            }));
            const ws = XLSX.utils.json_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Konversi Nilai');
            const { tahun_ajar, semester } = getActivePeriode();
            XLSX.writeFile(wb, `Konversi_${mapel}_${kelas}_${tahun_ajar}_S${semester}.xlsx`);
        } catch (e) {
            console.error(e);
            showToast('Gagal export: ' + (e.message || e), 'error');
        }
    }

enableArrowNavigation('table-nilai');
    }

    async function saveNilaiMapel(mapel, kelas) {
        setLoading(true, "Menyimpan Nilai (Batch)...");
        try {
            const { tahun_ajar, semester } = getActivePeriode();
            const inputs = Array.from(document.querySelectorAll('#tbody-nilai input'));
            const rowsMap = new Map();
            const numFields = new Set(['kehadiran','tugas','uh1','uh2','uh3','uh4','uh5','pas_pat']);

            for (const inp of inputs) {
                const nis = String(inp.dataset.nis || '').trim();
                const nama = String(inp.dataset.name || '').trim();
                if (!nis) continue;
                if (!rowsMap.has(nis)) {
                    rowsMap.set(nis, {
                        nis,
                        mapel: String(mapel),
                        kelas: String(kelas || ''),
                        nama_santri: nama,
                        tahun_ajar: String(tahun_ajar || ''),
                        semester: Number(semester) || 1,
                        kehadiran: 0,
                        tugas: 0,
                        uh1: 0, uh2: 0, uh3: 0, uh4: 0, uh5: 0,
                        pas_pat: 0,
                    });
                }
                const r = rowsMap.get(nis);
                const f = inp.dataset.field;
                if (!f) continue;
                if (numFields.has(f)) r[f] = (inp.value === '' ? 0 : Number(inp.value) || 0);
            }

            const rows = Array.from(rowsMap.values());
            if (!rows.length) throw new Error('Tidak ada data untuk disimpan.');

            await window.upsertNilaiMapelBatch(rows, {
                batchSize: 200,
                onProgress: (pct, lbl) => setLoadingProgress(pct, `Menyimpan ${lbl}`)
            });

            setLoadingProgress(0, 'Memuat ulang data...');
            await loadInitialData({ onProgress: (pct, label) => setLoadingProgress(pct, label) });
            showToast('Nilai Tersimpan!', 'success');
        } catch (e) {
            console.error(e);
            showToast('Gagal simpan nilai: ' + (e.message || e), 'error');
        } finally {
            setLoading(false);
        }
    }

    // --- WALI KELAS (FIX: Width Nama) ---
    function renderWaliPage(mode) {
        const u = getCurrentUser();
        const kelas = getWaliKelas(u);
        if (!kelas) { document.getElementById('main-content').innerHTML = `<div class="p-10 text-center text-red-500 font-bold">Bukan Wali Kelas.</div>`; return; }
        const siswa = students.filter(s => s.kelas === kelas);
        const main = document.getElementById('main-content');
        
        const headerBtn = `<div class="flex gap-2">
            ${mode!=='print' && mode!=='data' ? `<button onclick="triggerImport('${mode}', '${kelas}')" class="bg-green-600 text-white px-3 py-1 rounded shadow text-sm font-bold">Import</button>`:''}
            ${mode!=='print' ? `<button onclick="exportExcelWali('${mode}', '${kelas}')" class="bg-blue-600 text-white px-3 py-1 rounded shadow text-sm font-bold">Export</button>`:''}
            ${mode!=='print' && mode!=='data' ? `<button onclick="saveWaliDataLocal('${mode}')" class="bg-blue-800 text-white px-4 py-1 rounded shadow text-sm font-bold">Simpan</button>`:''}
        </div>`;

        let content = '';
        
        if (mode === 'data') {
            const rows = siswa.map((s, i) => `
                <tr class="hover:bg-gray-50 border-b">
                    <td class="p-2 text-center">${i+1}</td>
                    <td class="p-2 text-center">${s.nis||'-'}</td>
                    <td class="p-2 font-bold text-left"><div class="single-line" title="${s.name}">${s.name}</div></td>
                    <td class="p-2 text-center">${s.lp||s.jk||'-'}</td>
                    <td class="p-2 text-center">${s.ttl||'-'}</td>
                </tr>`).join('');
            content = `
              <div class="overflow-x-auto">
                <table class="w-full text-sm border std-table" id="table-data-kelas">
                  <thead class="bg-blue-600 text-white">
                    <tr>
                      <th class="p-2 w-12">No</th>
                      <th class="p-2">NIS</th>
                      <th class="p-2 text-left">Nama</th>
                      <th class="p-2 w-16">L/P</th>
                      <th class="p-2 w-40">TTL</th>
                    </tr>
                  </thead>
                  <tbody>${rows}</tbody>
                </table>
              </div>`;
        } 
 
        else if (mode === 'absen') {
            const rows = siswa.map((s, i) => {
                const { tahun_ajar, semester } = getActivePeriode();
                const sc = waliScores.find(x => String(x.nis)===String(s.nis) && String(x.tahun_ajar)===String(tahun_ajar) && Number(x.semester)===Number(semester)) || {};
                return `
                <tr class="hover:bg-gray-50 border-b tr-item">
                    <td class="p-2 text-center">${i+1}</td>
                    <td class="p-2 font-medium text-left filter-target"><div class="single-line" title="${s.name}" data-name="${s.name}">${s.name}</div></td>
                    <td class="p-2"><input type="number" data-id="${s.id}" data-nis="${s.nis||''}" data-field="hadir_s" value="${sc.hadir_s||0}"></td>
                    <td class="p-2"><input type="number" data-id="${s.id}" data-nis="${s.nis||''}" data-field="hadir_i" value="${sc.hadir_i||0}"></td>
                    <td class="p-2"><input type="number" data-id="${s.id}" data-nis="${s.nis||''}" data-field="hadir_a" value="${sc.hadir_a||0}"></td>
                    <td class="p-2"><input type="number" data-id="${s.id}" data-nis="${s.nis||''}" data-field="akhlak" value="${sc.akhlak||0}" class="bg-blue-50"></td>
                    <td class="p-2"><input type="number" data-id="${s.id}" data-nis="${s.nis||''}" data-field="kerajinan" value="${sc.kerajinan||0}" class="bg-blue-50"></td>
                    <td class="p-2"><input type="number" data-id="${s.id}" data-nis="${s.nis||''}" data-field="kebersihan" value="${sc.kebersihan||0}" class="bg-blue-50"></td>
                    <td class="p-2"><input type="number" data-id="${s.id}" data-nis="${s.nis||''}" data-field="kedisiplinan" value="${sc.kedisiplinan||0}" class="bg-blue-50"></td>
                </tr>`;
            }).join('');
            content = `<table class="w-full text-sm border std-table" id="table-absen"><thead class="bg-blue-600 text-white"><tr><th rowspan="2">No</th><th rowspan="2" class="text-left w-64">Nama</th><th colspan="3">Absensi</th><th colspan="4">Sikap (0-100)</th></tr><tr><th>S</th><th>I</th><th>A</th><th>Akhlak</th><th>Kerajinan</th><th>Bersih</th><th>Disiplin</th></tr></thead><tbody id="tbody-wali">${rows}</tbody></table>`;
        } 
        else if (mode === 'catatan') {
            const rows = siswa.map((s, i) => {
                const { tahun_ajar, semester } = getActivePeriode();
                const sc = waliScores.find(x => String(x.nis)===String(s.nis) && String(x.tahun_ajar)===String(tahun_ajar) && Number(x.semester)===Number(semester)) || {};
                return `
                <tr class="hover:bg-gray-50 border-b tr-item">
                    <td class="p-2 text-center">${i+1}</td>
                    <td class="p-2 font-medium text-left filter-target"><div class="single-line" title="${s.name}" data-name="${s.name}">${s.name}</div></td>
                    <td class="p-2"><textarea data-id="${s.id}" data-nis="${s.nis||''}" data-field="catatan" class="h-16">${sc.catatan||'-'}</textarea></td>
                    <td class="p-2"><textarea data-id="${s.id}" data-nis="${s.nis||''}" data-field="prestasi1" class="h-16">${sc.prestasi1||'-'}</textarea></td>
                    <td class="p-2"><textarea data-id="${s.id}" data-nis="${s.nis||''}" data-field="prestasi2" class="h-16">${sc.prestasi2||'-'}</textarea></td>
                    <td class="p-2"><textarea data-id="${s.id}" data-nis="${s.nis||''}" data-field="prestasi3" class="h-16">${sc.prestasi3||'-'}</textarea></td>
                </tr>`;
            }).join('');
            content = `<table class="w-full text-sm border std-table"><thead class="bg-blue-600 text-white"><tr><th>No</th><th class="text-left w-64">Nama</th><th>Catatan</th><th>Prestasi 1</th><th>Prestasi 2</th><th>Prestasi 3</th></tr></thead><tbody id="tbody-wali">${rows}</tbody></table>`;
        }
        else if (mode === 'print') {
            content = `<div class="p-8 text-center bg-gray-50 border rounded-lg">
                <h3 class="text-xl font-bold mb-4">Menu Cetak</h3>
                <div class="flex justify-center gap-4">
                    <button onclick="alert('Fitur Generate PDF akan aktif')" class="bg-blue-600 text-white px-6 py-3 rounded shadow font-bold hover:bg-blue-700">üìÑ Cetak Raport</button>
                    <button onclick="alert('Fitur Legger akan aktif')" class="bg-green-600 text-white px-6 py-3 rounded shadow font-bold hover:bg-green-700">üìä Cetak Legger</button>
                </div>
            </div>`;
        }

        main.innerHTML = `
        <div class="bg-white p-6 rounded shadow">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold capitalize">${(() => { const m = String(mode||""); const kelasTitle = kelas; if(m==="data") return `Wali Kelas ${kelasTitle}: Data`; if(m==="absen") return `Wali Kelas ${kelasTitle}: Absensi & Sikap`; if(m==="catatan") return `Wali Kelas ${kelasTitle}: Catatan & Prestasi`; if(m==="print") return `Wali Kelas ${kelasTitle}: Rapor dan Legger`; return `Wali Kelas ${kelasTitle}`; })()}</h2>
                ${headerBtn}
            </div>
            ${content}
        </div>`;
        if(mode==='absen') enableArrowNavigation('table-absen');
    }

    async function saveWaliDataLocal(mode) {
        setLoading(true, "Menyimpan Data Wali (Batch)...");
        try {
            const { tahun_ajar, semester } = getActivePeriode();
            const inputs = Array.from(document.querySelectorAll('#tbody-wali input, #tbody-wali textarea'));
            const rowsMap = new Map();
            const numeric = new Set(['hadir_s','hadir_i','hadir_a','akhlak','kerajinan','kebersihan','kedisiplinan']);
            const textFields = new Set(['catatan','prestasi1','prestasi2','prestasi3']);

            for (const inp of inputs) {
                const nis = String(inp.dataset.nis || '').trim();
                const sid = Number(inp.dataset.id) || null;
                if (!nis) continue;
                const s = students.find(x => String(x.nis) === String(nis)) || {};
                if (!rowsMap.has(nis)) {
                    rowsMap.set(nis, {
                        student_id: sid || s.id || null,
                        nis,
                        kelas: String(s.kelas || ''),
                        nama_santri: String(s.name || ''),
                        tahun_ajar: String(tahun_ajar || ''),
                        semester: Number(semester) || 1,
                        hadir_s: 0, hadir_i: 0, hadir_a: 0,
                        akhlak: 0, kerajinan: 0, kebersihan: 0, kedisiplinan: 0,
                        catatan: '-', prestasi1: '-', prestasi2: '-', prestasi3: '-',
                    });
                }
                const r = rowsMap.get(nis);
                const f = inp.dataset.field;
                if (!f) continue;
                if (numeric.has(f)) r[f] = (inp.value === '' ? 0 : Number(inp.value) || 0);
                else if (textFields.has(f)) r[f] = (String(inp.value || '').trim() || '-');
            }

            const rows = Array.from(rowsMap.values());
            if (!rows.length) throw new Error('Tidak ada data untuk disimpan.');

            await window.upsertNilaiWaliBatch(rows, {
                batchSize: 200,
                onProgress: (pct, lbl) => setLoadingProgress(pct, `Menyimpan ${lbl}`)
            });

            setLoadingProgress(0, 'Memuat ulang data...');
            await loadInitialData({ onProgress: (pct, label) => setLoadingProgress(pct, label) });
            showToast('Data Tersimpan!', 'success');
        } catch (e) {
            console.error(e);
            showToast('Gagal simpan wali: ' + (e.message || e), 'error');
        } finally {
            setLoading(false);
        }
    }

    // --- MUSYRIF PAGE (FIX: Width Nama) ---
    function renderMusyrifPage() {
        const u = getCurrentUser();
        const kelas = u.musyrif || '';
        const main = document.getElementById('main-content');
        if (!kelas) { main.innerHTML = `<div class="p-10 text-red-500 text-center font-bold">Bukan Musyrif</div>`; return; }
        
        const siswa = students.filter(s => s.kelas === kelas);
        const rows = siswa.map((s, i) => {
            const sc = musyrifScores.find(x => x.student_id === s.id) || {};
            return `
            <tr class="hover:bg-gray-50 border-b">
                <td class="p-2 text-center">${i+1}</td>
                <td class="p-2 text-center font-mono">${s.nis||'-'}</td>
                <td class="p-2 text-left font-bold filter-target"><div class="single-line" title="${s.name}" data-name="${s.name}">${s.name}</div></td>
                <td class="p-2"><input type="number" data-id="${s.id}" data-nis="${s.nis||''}" data-field="hafalan_wajib" value="${sc.hafalan_wajib||0}" class="nav-input"></td>
                <td class="p-2"><input type="number" data-id="${s.id}" data-nis="${s.nis||''}" data-field="hafalan_murojaah" value="${sc.hafalan_murojaah||0}" class="nav-input"></td>
                <td class="p-2"><input type="number" data-id="${s.id}" data-nis="${s.nis||''}" data-field="ziyadah" value="${sc.ziyadah||0}" class="nav-input"></td>
                <td class="p-2"><input type="number" data-id="${s.id}" data-nis="${s.nis||''}" data-field="fashohah" value="${sc.fashohah||0}" class="bg-blue-50 nav-input"></td>
            </tr>`;
        }).join('');

        main.innerHTML = `
        <div class="bg-white p-6 rounded shadow">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Musyrif Kelas ${kelas}</h2>
                <div class="flex gap-2">
                    <button onclick="triggerImport('musyrif', '${kelas}')" class="bg-green-600 text-white px-4 py-2 rounded font-bold shadow text-sm">Import</button>
                    <button onclick="exportExcelMusyrif('${kelas}')" class="bg-blue-600 text-white px-4 py-2 rounded font-bold shadow text-sm">Export</button>
                    <button onclick="saveMusyrifData()" class="bg-purple-600 text-white px-4 py-2 rounded font-bold shadow text-sm">Simpan</button>
                </div>
            </div>
            <table class="w-full text-sm border std-table"><thead class="bg-purple-600 text-white"><tr><th>No</th><th>NIS</th><th class="text-left w-64">Nama</th><th>Wajib</th><th>Murojaah</th><th>Ziyadah</th><th>Fashohah</th></tr></thead><tbody id="tbody-musyrif">${rows}</tbody></table>
        </div>`;
    }

    async function saveMusyrifData() {
        setLoading(true, "Menyimpan Hafalan (Batch)...");
        try {
            const { tahun_ajar, semester } = getActivePeriode();
            const inputs = Array.from(document.querySelectorAll('#tbody-musyrif input'));
            const rowsMap = new Map();
            const numFields = new Set(['hafalan_wajib','hafalan_murojaah','ziyadah','fashohah']);

            for (const inp of inputs) {
                const nis = String(inp.dataset.nis || '').trim();
                const sid = Number(inp.dataset.id) || null;
                if (!nis) continue;
                const s = students.find(x => String(x.nis) === String(nis)) || {};
                if (!rowsMap.has(nis)) {
                    rowsMap.set(nis, {
                        student_id: sid || s.id || null,
                        nis,
                        kelas: String(s.kelas || ''),
                        nama_santri: String(s.name || ''),
                        tahun_ajar: String(tahun_ajar || ''),
                        semester: Number(semester) || 1,
                        hafalan_wajib: 0,
                        hafalan_murojaah: 0,
                        ziyadah: 0,
                        fashohah: 0,
                    });
                }
                const r = rowsMap.get(nis);
                const f = inp.dataset.field;
                if (!f) continue;
                if (numFields.has(f)) r[f] = (inp.value === '' ? 0 : Number(inp.value) || 0);
            }

            const rows = Array.from(rowsMap.values());
            if (!rows.length) throw new Error('Tidak ada data untuk disimpan.');

            await window.upsertNilaiMusyrifBatch(rows, {
                batchSize: 200,
                onProgress: (pct, lbl) => setLoadingProgress(pct, `Menyimpan ${lbl}`)
            });

            setLoadingProgress(0, 'Memuat ulang data...');
            await loadInitialData({ onProgress: (pct, label) => setLoadingProgress(pct, label) });
            showToast('Tersimpan!', 'success');
        } catch (e) {
            console.error(e);
            showToast('Gagal simpan musyrif: ' + (e.message || e), 'error');
        } finally {
            setLoading(false);
        }
    }

    // --- IMPORT & EXPORT LOGIC ---
    let importContext = {};
    function triggerImport(type, p1, p2) {
        importContext = { type, p1, p2 };
        document.getElementById('file-import').value = '';
        document.getElementById('file-import').click();
    }
    document.getElementById('file-import').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (evt) => {
            try {
                const wb = XLSX.read(evt.target.result, { type: 'binary' });
                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: '', raw: false });
                previewImport(data);
            } catch (err) { console.error(err); showToast('Gagal: ' + err.message, 'error'); }
        };
        reader.readAsBinaryString(file);
    });

    // FUNGSI PREVIEW UNIVERSAL
    function previewImport(data) {
        if (!data || data.length === 0) { showToast("Excel Kosong", 'error'); return; }
        const type = importContext.type;

        // ADMIN: DATA GURU (Handling Mapel String -> JSON)
        if (type === 'guru') {
             window.tempImportDataGuru = data.map(row => {
                 let mapelArr = [];
                 if(row.Mapel_Ajar && typeof row.Mapel_Ajar === 'string') {
                     const parts = row.Mapel_Ajar.split(';');
                     parts.forEach(p => {
                         const match = p.trim().match(/([^(]+)\(([^)]+)\)/);
                         if(match) {
                             const mName = match[1].trim();
                             const mKelas = match[2].split(',').map(c=>c.trim()).filter(c=>c);
                             if(mName && mKelas.length > 0) mapelArr.push({nama: mName, kelas: mKelas});
                         }
                     });
                 }
                 return {
                    id: null, name: row.Nama, username: row.Username, password: row.Password || '123456',
                    role: row.Role || 'guru', kelas_wali: row.Wali_Kelas, musyrif: row.Musyrif,
                    jk: row.LP, // Added LP
                    mapel: mapelArr 
                 };
             });
             renderAdminGuru();
             showToast(`Preview ${data.length} Data Guru. Klik Simpan.`, 'success');
             return;
        }
        
        // ADMIN: DATA SANTRI (Handling JK)
                if (type === 'santri') {
             window.tempImportDataSantri = data.map(row => ({
                id: null,
                nis: (typeof _toNIS === 'function' ? _toNIS(row.NIS) : row.NIS),
                name: (row.Nama_Santri ?? row.Nama ?? row.NamaSantri ?? row.NAMA ?? row.NAMA_SANTRI),
                kelas: row.Kelas,
                jk: (row.JK ?? row.LP),

                ttl: row.TTL,
                status_keluarga: row.Status_Keluarga,
                anak_ke: row.Anak_Ke,
                asal_sekolah: row.Asal_Sekolah,
                tanggal_diterima: row.Tanggal_Diterima,
                diterima_kelas: row.Diterima_Kelas,

                nama_ayah: row.Nama_Ayah,
                nama_ibu: row.Nama_Ibu,
                pekerjaan_ayah: row.Pekerjaan_Ayah,
                pekerjaan_ibu: row.Pekerjaan_Ibu,
                alamat_ortu: row.Alamat_Ortu,

                nama_wali: row.Nama_Wali,
                pekerjaan_wali: row.Pekerjaan_Wali,
                alamat_wali: row.Alamat_Wali
             }));
             renderAdminSantri();
             showToast(`Preview ${data.length} Data Santri. Klik Simpan.`, 'success');
             return;
        }

        // NILAI/WALI/MUSYRIF (ISI INPUT)
        // FIX: sebelumnya cari td[data-name] (tidak ada), sehingga import selalu 0.
        // Sekarang kita pakai NIS sebagai kunci (lebih stabil) via atribut data-nis di input/textarea.
        let filledCount = 0;
        const _cssEscape = (s) => (window.CSS && CSS.escape) ? CSS.escape(String(s)) : String(s).replace(/[\\\"\']/g, '\\$&');
        const _getRowNIS = (row) => {
            const raw = row?.NIS ?? row?.Nis ?? row?.nis ?? row?.['N I S'] ?? row?.['NIS '] ?? '';
            return (typeof _toNIS === 'function') ? _toNIS(raw) : String(raw || '').trim();
        };
        const _findInputs = (row) => {
            const nis = _getRowNIS(row);
            if (nis) return Array.from(document.querySelectorAll(`[data-nis="${_cssEscape(nis)}"]`));
            // fallback legacy: match by data-name
            const nm = (row?.Nama ?? row?.nama ?? '').toString().trim();
            if (!nm) return [];
            return Array.from(document.querySelectorAll(`[data-name="${_cssEscape(nm)}"]`));
        };

        const _get = (row, keys) => {
            for (const k of keys) {
                if (row && row[k] !== undefined && row[k] !== null && String(row[k]).trim() !== '') return row[k];
            }
            return undefined;
        };

        data.forEach(row => {
            const inputs = _findInputs(row);
            if (inputs.length === 0) return;
            filledCount++;

            if (type === 'mapel') {
                const vHadir = _get(row, ['Hadir','hadir','KEHADIRAN']);
                const vUH1 = _get(row, ['UH1','uh1']);
                const vUH2 = _get(row, ['UH2','uh2']);
                const vUH3 = _get(row, ['UH3','uh3']);
                const vUH4 = _get(row, ['UH4','uh4']);
                const vUH5 = _get(row, ['UH5','uh5']);
                const vTugas = _get(row, ['Tugas','tugas']);
                const vPAS = _get(row, ['PAS/PAT','PAS_PAT','PASPAT','PAS','pas']);

                inputs.forEach(inp => {
                    const f = inp.dataset.field;
                    if(f==='kehadiran' && vHadir!==undefined) inp.value = vHadir;
                    if(f==='uh1' && vUH1!==undefined) inp.value = vUH1;
                    if(f==='uh2' && vUH2!==undefined) inp.value = vUH2;
                    if(f==='uh3' && vUH3!==undefined) inp.value = vUH3;
                    if(f==='uh4' && vUH4!==undefined) inp.value = vUH4;
                    if(f==='uh5' && vUH5!==undefined) inp.value = vUH5;
                    if(f==='tugas' && vTugas!==undefined) inp.value = vTugas;
                    if(f==='pas_pat' && vPAS!==undefined) inp.value = vPAS;
                });
            } else if (type === 'absen') {
                const vSakit = _get(row, ['Sakit','sakit']);
                const vIzin  = _get(row, ['Izin','izin']);
                const vAlpha = _get(row, ['Alpha','alpha','Alpa','alpa']);
                const vAkhlak = _get(row, ['Akhlak','akhlak']);
                const vKerajinan = _get(row, ['Kerajinan','kerajinan']);
                const vDisiplin = _get(row, ['Disiplin','disiplin']);
                const vBersih = _get(row, ['Bersih','bersih']);

                inputs.forEach(inp => {
                    const f = inp.dataset.field;
                    if(f==='hadir_s' && vSakit!==undefined) inp.value = vSakit;
                    if(f==='hadir_i' && vIzin!==undefined) inp.value = vIzin;
                    if(f==='hadir_a' && vAlpha!==undefined) inp.value = vAlpha;
                    if(f==='akhlak' && vAkhlak!==undefined) inp.value = vAkhlak;
                    if(f==='kerajinan' && vKerajinan!==undefined) inp.value = vKerajinan;
                    if(f==='kedisiplinan' && vDisiplin!==undefined) inp.value = vDisiplin;
                    if(f==='kebersihan' && vBersih!==undefined) inp.value = vBersih;
                });
            } else if (type === 'catatan') {
                const vCat = _get(row, ['Catatan','catatan']);
                const vP1  = _get(row, ['Prestasi_1','Prestasi1','Prestasi','prestasi']);
                const vP2  = _get(row, ['Prestasi_2','Prestasi2','prestasi2']);
                const vP3  = _get(row, ['Prestasi_3','Prestasi3','prestasi3']);

                inputs.forEach(inp => {
                    const f = inp.dataset.field;
                    if(f==='catatan' && vCat!==undefined) inp.value = vCat;
                    if(f==='prestasi1' && vP1!==undefined) inp.value = vP1;
                    if(f==='prestasi2' && vP2!==undefined) inp.value = vP2;
                    if(f==='prestasi3' && vP3!==undefined) inp.value = vP3;
                });
            } else if (type === 'musyrif') {
                const vWajib = _get(row, ['Hafalan_Wajib','HafalanWajib','wajib']);
                const vMuro  = _get(row, ['Murojaah','murojaah','Hafalan_Murojaah']);
                const vZiy   = _get(row, ['Ziyadah','ziyadah']);
                const vFash  = _get(row, ['Fashohah','fashohah']);

                inputs.forEach(inp => {
                    const f = inp.dataset.field;
                    if(f==='hafalan_wajib' && vWajib!==undefined) inp.value = vWajib;
                    if(f==='hafalan_murojaah' && vMuro!==undefined) inp.value = vMuro;
                    if(f==='ziyadah' && vZiy!==undefined) inp.value = vZiy;
                    if(f==='fashohah' && vFash!==undefined) inp.value = vFash;
                });
            }
        });

        showToast(`${filledCount} baris terisi. Klik Simpan.`, 'success');
    }

    async function saveAdminImport(type) {
        setLoading(true, "Menyimpan Data Import...");
        try {
            if (type === 'guru' && window.tempImportDataGuru) {
                let _doneGuru = 0;
                const _totalGuru = window.tempImportDataGuru.length;
                for (const u of window.tempImportDataGuru) {
                     // FIX: Remove 'classes' property (bug 400 bad request)
                     const payload = {
                        name: u.name, username: u.username, password: u.password,
                        role: u.role, wali: u.kelas_wali, musyrif: u.musyrif, 
                        jk: (u.jk || u.lp), mapel: u.mapel
                     };
                     const exist = users.find(x => x.username === u.username);
                     if(exist) await updateGuruInDB(exist.id, payload); else await addGuruToDB(payload);
                     _doneGuru++;
                     if(_totalGuru) setLoadingProgress(Math.round((_doneGuru/_totalGuru)*100), `Menyimpan Guru (${_doneGuru}/${_totalGuru})`);
                }
                window.tempImportDataGuru = null;
            } 
            else if (type === 'santri' && window.tempImportDataSantri) {
                await upsertSantriBatchByNIS(window.tempImportDataSantri, {
                    batchSize: 200,
                    onProgress: (pct, lbl) => setLoadingProgress(pct, `Menyimpan ${lbl}`)
                });
                window.tempImportDataSantri = null;
            }
            setLoadingProgress(0, 'Memuat ulang data...');
            await loadInitialData({ onProgress: (pct, label) => setLoadingProgress(pct, label) });
            if(type==='guru') renderAdminGuru(); else renderAdminSantri();
            showToast('Import Berhasil Disimpan!', 'success');
        } catch(e) { console.error(e); showToast('Gagal Simpan: '+e.message, 'error'); }
        setLoading(false);
    }

        function downloadExcelGuru() {
        if (!users.length) return;
        const data = users.map(u => ({
            Nama: u.name,
            Username: u.username,
            Password: u.password,
            Role: (u.role || 'guru'),
            JK: u.jk || u.lp || '',
            Wali_Kelas: u.wali || u.kelas_wali || '',
            Musyrif: u.musyrif || '',
            Mapel_Ajar: parseMapelData(u.mapel).map(m=>`${m.nama}(${m.kelas})`).join(';')
        }));
        saveExcel(data, "Data_Guru.xlsx", [{wch:30}, {wch:15}, {wch:10}, {wch:10}, {wch:5}, {wch:10}, {wch:10}, {wch:40}]);
    }

    function downloadExcelSantri() {
        if (!students.length) return;

        const mapData = students.map(s => ({
            NIS: s.nis,
            Nama_Santri: s.name,
            JK: s.jk || s.lp || '',
            Kelas: s.kelas || '',
            TTL: s.ttl || '',
            Status_Keluarga: s.status_keluarga || '',
            Anak_Ke: s.anak_ke ?? '',
            Asal_Sekolah: s.asal_sekolah || '',
            Tanggal_Diterima: s.tanggal_diterima || '',
            Diterima_Kelas: s.diterima_kelas || '',
            Nama_Ayah: s.nama_ayah || '',
            Nama_Ibu: s.nama_ibu || '',
            Pekerjaan_Ayah: s.pekerjaan_ayah || '',
            Pekerjaan_Ibu: s.pekerjaan_ibu || '',
            Alamat_Ortu: s.alamat_ortu || '',
            Nama_Wali: s.nama_wali || '',
            Pekerjaan_Wali: s.pekerjaan_wali || '',
            Alamat_Wali: s.alamat_wali || ''
        }));

        saveExcel(
            mapData,
            "Data_Santri_Lengkap.xlsx",
            [
                {wch:15},{wch:30},{wch:5},{wch:10},{wch:25},{wch:18},{wch:10},{wch:25},
                {wch:15},{wch:15},{wch:25},{wch:25},{wch:20},{wch:20},{wch:30},
                {wch:25},{wch:20},{wch:30}
            ]
        );
    }

    function exportExcelNilai(mapel, kelas) {
        const siswa = students.filter(s => s.kelas === kelas);
        const data = siswa.map(s => {
            const { tahun_ajar, semester } = getActivePeriode();
            const sc = scores.find(x => String(x.nis) === String(s.nis) && x.mapel === mapel && String(x.tahun_ajar)===String(tahun_ajar) && Number(x.semester)===Number(semester)) || {};
            return {NIS: s.nis, Nama: s.name, Kelas: kelas, Mapel: mapel, Hadir: sc.kehadiran||0, UH1: sc.uh1||0, UH2: sc.uh2||0, UH3: sc.uh3||0, UH4: sc.uh4||0, UH5: sc.uh5||0, Tugas: sc.tugas||0, "PAS/PAT": sc.pas_pat||sc.pas||0};
        });
        saveExcel(data, `Nilai_${mapel}_${kelas}.xlsx`, [{wch:15}, {wch:30}]);
    }
    function exportExcelWali(mode, kelas) {
        const siswa = students.filter(s => s.kelas === kelas);
        let data = [];
        if(mode==='absen') {
             data = siswa.map(s => {
                const { tahun_ajar, semester } = getActivePeriode();
                const sc = waliScores.find(x => String(x.nis)===String(s.nis) && String(x.tahun_ajar)===String(tahun_ajar) && Number(x.semester)===Number(semester)) || {};
                return { Nama: s.name, Sakit: sc.hadir_s||0, Izin: sc.hadir_i||0, Alpha: sc.hadir_a||0, Akhlak: sc.akhlak||0, Kerajinan: sc.kerajinan||0, Disiplin: sc.kedisiplinan||0, Bersih: sc.kebersihan||0 };
            });
        }
        else if(mode==='catatan') {
             data = siswa.map(s => {
                const { tahun_ajar, semester } = getActivePeriode();
                const sc = waliScores.find(x => String(x.nis)===String(s.nis) && String(x.tahun_ajar)===String(tahun_ajar) && Number(x.semester)===Number(semester)) || {};
                return { Nama: s.name, Catatan: sc.catatan||'-', Prestasi_1: sc.prestasi1||'-', Prestasi_2: sc.prestasi2||'-', Prestasi_3: sc.prestasi3||'-' };
            });
        }
        saveExcel(data, `Wali_${mode}_${kelas}.xlsx`, [{wch:30}]);
    }
    function exportExcelMusyrif(kelas) {
        const siswa = students.filter(s => s.kelas === kelas);
        const data = siswa.map(s => {
            const { tahun_ajar, semester } = getActivePeriode();
            const sc = musyrifScores.find(x => String(x.nis)===String(s.nis) && String(x.tahun_ajar)===String(tahun_ajar) && Number(x.semester)===Number(semester)) || {};
            return { NIS: s.nis, Nama: s.name, Kelas: kelas, Hafalan_Wajib: sc.hafalan_wajib||0, Murojaah: sc.hafalan_murojaah||0, Ziyadah: sc.ziyadah||0, Fashohah: sc.fashohah||0 };
        });
        saveExcel(data, `Hafalan_${kelas}.xlsx`, [{wch:15}, {wch:30}]);
    }
    function saveExcel(json, filename, colWidths = []) {
        const ws = XLSX.utils.json_to_sheet(json);
        if(colWidths.length > 0) ws['!cols'] = colWidths;
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        XLSX.writeFile(wb, filename);
    }

    // --- UTILS ---
    function setLoading(active, text="Memproses...") {
        const ov = document.getElementById('loading-overlay');
        document.getElementById('loading-text').innerText = text;
        if(active) ov.classList.remove('hidden'); else ov.classList.add('hidden');
    }

    // Progress overlay helper (dipakai saat fetch bertahap & simpan batch)
    // pct: 0..100
    function setLoadingProgress(pct, label = '') {
        const ov = document.getElementById('loading-overlay');
        const textEl = document.getElementById('loading-text');
        const wrap = document.getElementById('loading-progress-wrap');
        const bar = document.getElementById('loading-progress-bar');
        const pctEl = document.getElementById('loading-progress-text');

        // Pastikan overlay tampil
        ov.classList.remove('hidden');

        const safePct = Math.max(0, Math.min(100, Number(pct) || 0));
        if (label) textEl.innerText = label;

        // Tampilkan progress bar
        wrap.classList.remove('hidden');
        bar.style.width = safePct + '%';
        pctEl.innerText = safePct + '%';
    }

    // Opsional: sembunyikan progress bar (overlay tetap bisa dipakai)
    function resetLoadingProgress() {
        const wrap = document.getElementById('loading-progress-wrap');
        const bar = document.getElementById('loading-progress-bar');
        const pctEl = document.getElementById('loading-progress-text');
        if (wrap) wrap.classList.add('hidden');
        if (bar) bar.style.width = '0%';
        if (pctEl) pctEl.innerText = '0%';
    }
    function showToast(msg, type='info') {
        const t = document.getElementById('toast');
        document.getElementById('toast-msg').innerText = msg;
        t.className = `fixed bottom-5 right-5 px-6 py-3 rounded shadow-lg flex items-center gap-3 z-50 text-white ${type === 'error' ? 'bg-red-600' : type==='success'?'bg-green-600':'bg-gray-800'}`;
        t.classList.remove('translate-y-20');
        setTimeout(() => t.classList.add('translate-y-20'), 3000);
    }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); }
    function logout() { localStorage.removeItem('erapor_user'); window.location.href = 'index.html'; }
    function filterTable(tbodyId) {
        const filter = document.activeElement.value.toUpperCase();
        const tr = document.getElementById(tbodyId).getElementsByTagName('tr');
        for (let i = 0; i < tr.length; i++) {
            const td = tr[i].getElementsByClassName('filter-target')[0];
            if (td) tr[i].style.display = (td.textContent || td.innerText).toUpperCase().indexOf(filter) > -1 ? "" : "none";
        }
    }
    function enableArrowNavigation(tableId) {
        const table = document.getElementById(tableId); if(!table) return;
        table.addEventListener('keydown', (e) => {
            if (!['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) return;
            const active = document.activeElement;
            if (active.tagName !== 'INPUT' && active.tagName !== 'TEXTAREA') return;
            e.preventDefault();
            const td = active.closest('td'); const tr = td.closest('tr');
            const cellIndex = td.cellIndex; const rowIndex = tr.rowIndex; const rows = table.rows;
            let nextInput;
            if (e.key === 'ArrowUp' && rowIndex > 1) nextInput = rows[rowIndex - 1].cells[cellIndex].querySelector('input, textarea');
            else if (e.key === 'ArrowDown' && rowIndex < rows.length - 1) nextInput = rows[rowIndex + 1].cells[cellIndex].querySelector('input, textarea');
            if(nextInput) { nextInput.focus(); nextInput.select(); }
        });
    }

    function addMapelRow(n='', k=[]) {
        const div = document.createElement('div');
        div.className = "flex gap-2 items-start mapel-row border-b pb-2 mb-2";
        div.innerHTML = `
            <div class="flex-1 space-y-1">
                <input type="text" class="inp-mapel-name w-full border p-1 rounded text-sm" placeholder="Nama Mapel (ex: Matematika)" value="${n}">
                <input type="text" class="inp-mapel-kelas w-full border p-1 rounded text-sm" placeholder="Kelas (ex: 10-A, 10-B)" value="${k.join(', ')}">
            </div>
            <button onclick="this.parentElement.remove()" class="text-red-500 font-bold px-2">x</button>`;
        document.getElementById('mapel-container').appendChild(div);
    }

        function openModal(type) {
        document.getElementById('admin-modal').classList.remove('hidden');
        document.querySelectorAll('#admin-modal input').forEach(i => i.value = '');
        document.querySelectorAll('#admin-modal select').forEach(i => i.value = '');
        document.getElementById('edit-id').value = '';
        document.getElementById('mapel-container').innerHTML = '';

        if (type === 'santri') {
            document.getElementById('modal-title').innerText = 'Form Data Santri';
            document.getElementById('form-santri-fields').classList.remove('hidden');
            document.getElementById('form-guru-fields').classList.add('hidden');
        } else {
            document.getElementById('modal-title').innerText = 'Form Data Guru';
            document.getElementById('form-santri-fields').classList.add('hidden');
            document.getElementById('form-guru-fields').classList.remove('hidden');
            // default role guru
            if (document.getElementById('inp-role')) document.getElementById('inp-role').value = 'guru';
            addMapelRow();
        }
    }

    function closeModal() { document.getElementById('admin-modal').classList.add('hidden'); }
    
        function editGuru(id) {
        const u = users.find(x => x.id == id);
        if (!u) { showToast('Data guru tidak ditemukan.', 'error'); return; }
        openModal('guru');
        document.getElementById('edit-id').value = u.id;
        document.getElementById('inp-nama').value = u.name || u.nama_guru || '';
        document.getElementById('inp-username').value = u.username || '';
        document.getElementById('inp-kelas-wali').value = getWaliKelas(u);
        document.getElementById('inp-musyrif').value = u.musyrif || '';
        document.getElementById('inp-role').value = (u.role || 'guru');
        document.getElementById('inp-jk-guru').value = (u.jk || u.lp || '');

        const mapelData = parseMapelData(u.mapel);
        document.getElementById('mapel-container').innerHTML = '';
        if (mapelData.length > 0) mapelData.forEach(m => addMapelRow(m.nama, m.kelas));
        else addMapelRow();
    }

    function editSantri(id) {
        const s = students.find(x => x.id == id);
        if (!s) { showToast('Data santri tidak ditemukan.', 'error'); return; }
        openModal('santri');
        document.getElementById('edit-id').value = s.id;
        document.getElementById('inp-nama').value = s.name || s.nama_santri || '';
        document.getElementById('inp-nis').value = s.nis || '';
        document.getElementById('inp-kelas').value = s.kelas || '';
        if (document.getElementById('inp-jk-santri')) document.getElementById('inp-jk-santri').value = s.jk || s.lp || '';

        // kolom lengkap
        document.getElementById('inp-ttl').value = s.ttl || '';
        document.getElementById('inp-status-keluarga').value = s.status_keluarga || '';
        document.getElementById('inp-anak-ke').value = (s.anak_ke ?? '');
        document.getElementById('inp-asal-sekolah').value = s.asal_sekolah || '';
        document.getElementById('inp-tanggal-diterima').value = s.tanggal_diterima || '';
        document.getElementById('inp-diterima-kelas').value = s.diterima_kelas || '';
        document.getElementById('inp-nama-ayah').value = s.nama_ayah || '';
        document.getElementById('inp-nama-ibu').value = s.nama_ibu || '';
        document.getElementById('inp-pekerjaan-ayah').value = s.pekerjaan_ayah || '';
        document.getElementById('inp-pekerjaan-ibu').value = s.pekerjaan_ibu || '';
        document.getElementById('inp-alamat-ortu').value = s.alamat_ortu || '';
        document.getElementById('inp-nama-wali').value = s.nama_wali || '';
        document.getElementById('inp-pekerjaan-wali').value = s.pekerjaan_wali || '';
        document.getElementById('inp-alamat-wali').value = s.alamat_wali || '';
    }


    async function saveData() {
        setLoading(true, "Menyimpan...");
        const id = document.getElementById('edit-id').value;
        const isSantri = !document.getElementById('form-santri-fields').classList.contains('hidden');
        try {
            if (isSantri) {
                const data = {
                    name: document.getElementById('inp-nama').value,
                    nis: document.getElementById('inp-nis').value,
                    kelas: document.getElementById('inp-kelas').value,
                    jk: document.getElementById('inp-jk-santri').value,

                    ttl: document.getElementById('inp-ttl').value,
                    status_keluarga: document.getElementById('inp-status-keluarga').value,
                    anak_ke: document.getElementById('inp-anak-ke').value,
                    asal_sekolah: document.getElementById('inp-asal-sekolah').value,
                    tanggal_diterima: document.getElementById('inp-tanggal-diterima').value,
                    diterima_kelas: document.getElementById('inp-diterima-kelas').value,

                    nama_ayah: document.getElementById('inp-nama-ayah').value,
                    nama_ibu: document.getElementById('inp-nama-ibu').value,
                    pekerjaan_ayah: document.getElementById('inp-pekerjaan-ayah').value,
                    pekerjaan_ibu: document.getElementById('inp-pekerjaan-ibu').value,
                    alamat_ortu: document.getElementById('inp-alamat-ortu').value,

                    nama_wali: document.getElementById('inp-nama-wali').value,
                    pekerjaan_wali: document.getElementById('inp-pekerjaan-wali').value,
                    alamat_wali: document.getElementById('inp-alamat-wali').value
                };
                if (id) await updateSantriInDB(id, data);
                else await addSantriToDB(data);
            } else {
                const rows = document.querySelectorAll('.mapel-row');
                const mapelStructure = [];
                // REMOVED 'allClasses' to fix Bug 400
                rows.forEach(r => {
                    const nama = r.querySelector('.inp-mapel-name').value.trim();
                    const kStr = r.querySelector('.inp-mapel-kelas').value;
                    if(nama) {
                        const kArr = kStr.split(',').map(s => s.trim()).filter(s => s !== '');
                        mapelStructure.push({ nama, kelas: kArr });
                    }
                });
                
                const data = {
                    name: document.getElementById('inp-nama').value, username: document.getElementById('inp-username').value,
                    role: document.getElementById('inp-role').value || 'guru',
                    wali: document.getElementById('inp-kelas-wali').value, 
                    musyrif: document.getElementById('inp-musyrif').value,
                    jk: document.getElementById('inp-jk-guru').value, // JK Guru
                    mapel: mapelStructure
                };
                const pass = document.getElementById('inp-password').value;
                if (pass) data.password = pass; else if (!id) data.password = '123456';
                if (id) await updateGuruInDB(id, data); else await addGuruToDB(data);
            }
            setLoadingProgress(0, 'Memuat ulang data...');
            await loadInitialData({ onProgress: (pct, label) => setLoadingProgress(pct, label) }); 
            if(isSantri) renderAdminSantri(); else renderAdminGuru();
            closeModal(); showToast('Tersimpan', 'success');
        } catch (e) { console.error(e); showToast('Gagal: ' + e.message, 'error'); }
        setLoading(false);
    }
  </script>
</body>
</html>
