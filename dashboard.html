<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Rapor Digital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="data.js"></script>

  <style>
    .sidebar-bg { background-color: #1e3a8a; }
    .custom-scroll::-webkit-scrollbar { width: 8px; }
    .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input:focus, textarea:focus { background-color: #eff6ff !important; outline: 2px solid #2563eb; }
    #loading-overlay { background: rgba(255,255,255,0.8); backdrop-filter: blur(2px); }
    
    .std-table th { background-color: #2563eb; color: white; padding: 10px; border: 1px solid #e5e7eb; white-space: nowrap; }
    .std-table td { padding: 8px; border: 1px solid #e5e7eb; vertical-align: middle; }
    .std-table tr:hover { background-color: #f9fafb; }
    .std-table input, .std-table textarea { border: 1px solid #d1d5db; border-radius: 4px; padding: 4px; font-size: 0.875rem; width: 100%; text-align: center;}
    .std-table textarea { text-align: left; }
    
    /* FIX: Nama 1 Baris */
    .single-line { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px; display: block; }

    /* =====================
       Mobile friendliness
       ===================== */
    /* Make wide tables scroll horizontally on small screens */
    @media (max-width: 768px) {
      .std-table { display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; width: 100%; }
      .std-table thead, .std-table tbody { width: max-content; }
      .std-table th { padding: 8px; font-size: 0.8rem; }
      .std-table td { padding: 6px; }
      .std-table input, .std-table textarea { font-size: 0.875rem; min-height: 40px; }
      .single-line { max-width: 180px; }
    }

    /* Overlay backdrop for offcanvas sidebar */
    #sidebar-backdrop { background: rgba(0,0,0,0.45); }

    /* Pastikan font konsisten (hindari monospace berbeda pada kolom seperti NIS) */
    .font-mono{ font-family: inherit !important; }
  </style>
</head>
<body class="bg-gray-100 flex h-screen overflow-hidden">

  <!-- Backdrop (mobile sidebar) -->
  <div id="sidebar-backdrop" class="fixed inset-0 hidden z-10 md:hidden" onclick="closeSidebar()"></div>

  <!-- Sidebar: offcanvas on mobile, static on desktop -->
  <aside class="w-64 sidebar-bg text-white flex flex-col shadow-xl flex-shrink-0 transition-transform duration-300 fixed md:relative inset-y-0 left-0 z-20 transform -translate-x-full md:translate-x-0" id="sidebar">
    <div class="p-6 border-b border-blue-800 flex items-center gap-3">
      <div class="inline-flex items-center justify-center p-1 rounded-lg border border-white/30 bg-white/5">
        <img src="logo_putih.png" alt="Logo" class="h-10 w-auto object-contain" />
      </div>
      <div class="leading-tight">
        <h1 class="text-xl font-bold tracking-wide">Rapor Digital</h1>
        <p class="text-xs text-blue-200">Pontren Husnul Khotimah</p>
      </div>
    </div>
    <div class="p-4 bg-blue-800 bg-opacity-50 text-xs border-b border-blue-700">
        <p id="user-info-name" class="font-bold text-sm truncate">Loading...</p>
        <p id="user-info-role" class="text-blue-200 capitalize">...</p>
    </div>
    <nav class="flex-1 overflow-y-auto custom-scroll p-4">
      <ul id="sidebar-menu" class="space-y-1"></ul>
    </nav>
    <div class="p-4 border-t border-blue-700">
        <button onclick="logout()" class="w-full py-2 bg-red-600 hover:bg-red-700 text-white rounded font-bold shadow text-sm transition">Keluar</button>
    </div>
  </aside>

  <main class="flex-1 flex flex-col h-screen overflow-hidden relative min-w-0">
    <header class="bg-white shadow p-4 flex justify-between items-center md:hidden z-10">
        <div class="flex items-center gap-2">
            <div class="inline-flex items-center justify-center p-1 rounded-lg border border-gray-200 bg-white">
            <img src="logo.png" alt="Logo" class="h-8 w-auto object-contain"/>
        </div>
            <h2 class="font-bold text-gray-700">Rapor Digital</h2>
        </div>
        <button onclick="toggleSidebar()" class="text-blue-600 font-bold">☰ Menu</button>
    </header>
    <div id="main-content" class="flex-1 overflow-auto p-3 md:p-6 relative">
        <div class="flex items-center justify-center h-full"><p class="text-gray-500 animate-pulse">Memuat data...</p></div>
    </div>
    <div id="loading-overlay" class="absolute inset-0 hidden flex flex-col items-center justify-center z-50">
        <div class="inline-flex items-center justify-center p-2 rounded-xl border border-gray-200 bg-white mb-3">
        <img src="logo.png" alt="Logo" class="h-16 w-auto object-contain"/>
        </div>
        <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-2 text-blue-800 font-bold" id="loading-text">Memproses...</p>
        <div id="loading-progress-wrap" class="w-72 mt-3 hidden">
            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                <div id="loading-progress-bar" class="bg-blue-600 h-3 rounded-full" style="width:0%"></div>
            </div>
            <p id="loading-progress-text" class="text-xs text-gray-700 mt-1 text-center">0%</p>
        </div>
    
    </div>
  </main>

  <div id="admin-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
      <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
        <h3 id="modal-title" class="text-xl font-bold text-gray-800">Form Data</h3>
        <button onclick="closeModal()" class="text-gray-500 hover:text-red-500 font-bold text-2xl">&times;</button>
      </div>
      <div class="p-6 overflow-y-auto custom-scroll flex-1">
        <input type="hidden" id="edit-id"> 
        <div class="space-y-4">
            <div><label class="block text-sm font-bold">Nama Lengkap</label><input type="text" id="inp-nama" class="w-full border p-2 rounded"></div>
            
                        <div id="form-santri-fields" class="hidden space-y-4">
                <div>
                    <label class="block text-sm font-bold">Nama Arab</label>
                    <input type="text" id="inp-nama-arab" class="w-full border p-2 rounded" placeholder="(opsional) اكتب الاسم بالعربية">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-bold">NIS</label>
                        <input type="text" id="inp-nis" class="w-full border p-2 rounded" placeholder="Wajib unik">
                    </div>
                    <div>
                        <label class="block text-sm font-bold">Kelas</label>
                        <input type="text" id="inp-kelas" class="w-full border p-2 rounded" placeholder="10-A">
                    </div>
                    <div>
                        <label class="block text-sm font-bold">JK</label>
                        <select id="inp-jk-santri" class="w-full border p-2 rounded">
                            <option value="">- Pilih -</option>
                            <option value="L">L</option>
                            <option value="P">P</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold">TTL</label>
                        <input type="text" id="inp-ttl" class="w-full border p-2 rounded" placeholder="Kuningan, 12-01-2010">
                    </div>
                    <div>
                        <label class="block text-sm font-bold">Status Keluarga</label>
                        <input type="text" id="inp-status-keluarga" class="w-full border p-2 rounded" placeholder="Anak Kandung / Yatim / Piatu / ...">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-bold">Anak Ke-</label>
                        <input type="number" id="inp-anak-ke" class="w-full border p-2 rounded" placeholder="(boleh kosong)">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold">Asal Sekolah</label>
                        <input type="text" id="inp-asal-sekolah" class="w-full border p-2 rounded">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold">Tanggal Diterima</label>
                        <input type="text" id="inp-tanggal-diterima" class="w-full border p-2 rounded" placeholder="YYYY-MM-DD / DD/MM/YYYY">
                    </div>
                    <div>
                        <label class="block text-sm font-bold">Diterima Kelas</label>
                        <input type="text" id="inp-diterima-kelas" class="w-full border p-2 rounded" placeholder="Kelas awal diterima">
                    </div>
                </div>

                <div class="border p-4 rounded bg-gray-50">
                    <div class="font-bold text-sm mb-3">Data Orang Tua</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold">Nama Ayah</label>
                            <input type="text" id="inp-nama-ayah" class="w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-bold">Pekerjaan Ayah</label>
                            <input type="text" id="inp-pekerjaan-ayah" class="w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-bold">Nama Ibu</label>
                            <input type="text" id="inp-nama-ibu" class="w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-bold">Pekerjaan Ibu</label>
                            <input type="text" id="inp-pekerjaan-ibu" class="w-full border p-2 rounded">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold">Alamat Ortu</label>
                            <input type="text" id="inp-alamat-ortu" class="w-full border p-2 rounded">
                        </div>
                    </div>
                </div>

                <div class="border p-4 rounded bg-gray-50">
                    <div class="font-bold text-sm mb-3">Data Wali</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold">Nama Wali</label>
                            <input type="text" id="inp-nama-wali" class="w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block text-sm font-bold">Pekerjaan Wali</label>
                            <input type="text" id="inp-pekerjaan-wali" class="w-full border p-2 rounded">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold">Alamat Wali</label>
                            <input type="text" id="inp-alamat-wali" class="w-full border p-2 rounded">
                        </div>
                    </div>
                </div>
            </div>

            <div id="form-guru-fields" class="hidden space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-bold">Username</label><input type="text" id="inp-username" class="w-full border p-2 rounded"></div>
                    <div><label class="block text-sm font-bold">Password</label><input type="text" id="inp-password" class="w-full border p-2 rounded" placeholder="Isi untuk ubah"></div>
                </div>
                                <div class="grid grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-bold">Role</label>
                        <select id="inp-role" class="w-full border p-2 rounded">
                            <option value="guru">guru</option>
                            <option value="admin">admin</option>
                        </select>
                     </div>
                     <div>
                        <label class="block text-sm font-bold">JK</label>
                        <select id="inp-jk-guru" class="w-full border p-2 rounded">
                            <option value="">- Pilih -</option>
                            <option value="L">L</option>
                            <option value="P">P</option>
                        </select>
                     </div>
</div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
  <div><label class="block text-sm font-bold">Wali Kelas</label><input type="text" id="inp-kelas-wali" class="w-full border p-2 rounded" placeholder="Contoh: 10-A"></div>
  <div><label class="block text-sm font-bold">Musyrif (Kelas)</label><input type="text" id="inp-musyrif" class="w-full border p-2 rounded" placeholder="Contoh: 10-A"></div>
</div>

                <div class="border p-4 rounded bg-gray-50 mt-2">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-bold">Mapel & Kelas Ajar</label>
                        <button onclick="addMapelRow()" class="text-xs bg-green-600 text-white px-2 py-1 rounded shadow">+ Tambah Mapel</button>
                    </div>
                    <div id="mapel-container" class="space-y-3"></div>
                </div>
            </div>
        </div>
      </div>
      <div class="p-4 border-t bg-gray-50 rounded-b-lg flex justify-end gap-2">
        <button onclick="closeModal()" class="px-4 py-2 bg-gray-500 text-white rounded">Batal</button>
        <button onclick="saveData()" class="px-6 py-2 bg-blue-600 text-white rounded font-bold shadow">Simpan</button>
      </div>
    </div>
  </div>

  <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded shadow-lg transform translate-y-20 transition-transform duration-300 flex items-center gap-3 z-50">
    <span id="toast-msg">Notifikasi</span>
  </div>
  <input type="file" id="file-import" class="hidden" accept=".xlsx, .xls">

  <script src="inline.js"></script>

</body>
</html>