<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Database Pesantren</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; padding: 20px; color: #334155; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .controls { display: flex; gap: 10px; }
        .status-box { padding: 10px; border-radius: 6px; font-weight: bold; margin-bottom: 20px; text-align: center; }
        .status-loading { background: #fff7ed; color: #c2410c; border: 1px solid #fdba74; }
        .status-success { background: #f0fdf4; color: #15803d; border: 1px solid #86efac; display: none; }
        .status-error { background: #fef2f2; color: #b91c1c; border: 1px solid #fca5a5; display: none; }
        
        .tabs { display: flex; border-bottom: 2px solid #cbd5e1; margin-bottom: 15px; }
        .tab { padding: 10px 20px; cursor: pointer; font-weight: bold; color: #64748b; }
        .tab.active { color: #2563eb; border-bottom: 3px solid #2563eb; margin-bottom: -2px; }

        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-success { background: #16a34a; color: white; }
        .btn-outline { border: 1px solid #cbd5e1; background: white; }
        .hidden { display: none; }

        .table-container { background: white; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; white-space: nowrap; }
        th { background: #f8fafc; font-size: 0.9rem; text-transform: uppercase; }
        .input-cell { width: 100%; padding: 6px; border: 1px solid #94a3b8; border-radius: 4px; box-sizing: border-box;}
        .new-row { background-color: #dcfce7; }
    </style>
</head>
<body>

<div class="header">
    <h2>Sistem Database Terpusat</h2>
    <div class="controls">
        <button id="btnAddRow" class="btn btn-outline hidden" onclick="addNewRow()">+ Tambah Baris</button>
        <button id="btnToggleEdit" class="btn btn-primary" onclick="toggleEditMode()">‚úèÔ∏è Edit Mode</button>
        <button id="btnSave" class="btn btn-success hidden" onclick="saveAllChanges()">üíæ Simpan Perubahan</button>
    </div>
</div>

<div id="statusBox" class="status-box status-loading">
    ‚è≥ Menghubungkan ke Database... (Cek Konfigurasi JS Anda)
</div>

<div class="tabs">
    <div class="tab active" onclick="switchTab('santri')">Data Santri</div>
    <div class="tab" onclick="switchTab('pegawai')">Data Pegawai</div>
</div>

<div class="table-container">
    <table id="mainTable">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    // --- 1. KONFIGURASI WAJIB DIISI ---
    // GANTI 'https://xxxx' dengan URL Supabase Anda
    // GANTI 'eyJ...' dengan Anon Key Supabase Anda
    
    const PROJECT_URL = 'https://rfmlsxtchzhstheqdmla.supabase.co'; 
    const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmbWxzeHRjaHpoc3RoZXFkbWxhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0OTA2MDEsImV4cCI6MjA4MjA2NjYwMX0.uuBqvhQ-1fsB2cF63-uluHpS6I-1JuYv5dF1bPcZdrU'; 
    
    // Variabel Global
    let dbConnection = null;
    let currentTab = 'santri';
    let isEditMode = false;
    let tableData = []; 

    // --- 2. CEK KONEKSI AWAL ---
    function initApp() {
        try {
            // Validasi URL sederhana
            if (PROJECT_URL.includes('xxxx') || PROJECT_URL.includes('GANTI_DENGAN')) {
                throw new Error("URL/KEY Supabase belum diisi di kode!");
            }

            // Inisialisasi Supabase
            dbConnection = window.supabase.createClient(PROJECT_URL, ANON_KEY);
            console.log("Supabase client initialized");
            
            // Tes Koneksi sederhana
            loadData();

        } catch (err) {
            showError("Gagal Inisialisasi: " + err.message);
        }
    }

    // --- DEFINISI SKEMA ---
    const SCHEMA = {
        santri: {
            view: 'view_santri_lengkap',
            rpc_insert: 'tambah_data_santri',
            primary_key: 'santri_id',
            columns: [
                { key: 'nis', label: 'NIS', table: 'santri', editable: true },
                { key: 'nama_lengkap', label: 'Nama Lengkap', table: 'orang', editable: true },
                { key: 'jenis_kelamin', label: 'L/P', table: 'orang', editable: true, type: 'select', options: ['L', 'P'] },
                { key: 'kelas_saat_ini', label: 'Kelas', table: 'santri', editable: true },
                { key: 'no_hp', label: 'No HP', table: 'orang', editable: true },
                { key: 'status_santri', label: 'Status', table: 'santri', editable: true } 
            ]
        },
        pegawai: {
            view: 'view_pegawai_lengkap', 
            rpc_insert: 'tambah_data_pegawai',
            primary_key: 'pegawai_id',
            columns: [
                { key: 'nip', label: 'NIP', table: 'pegawai', editable: true },
                { key: 'nama_lengkap', label: 'Nama Pegawai', table: 'orang', editable: true },
                { key: 'jenis_kelamin', label: 'L/P', table: 'orang', editable: true, type: 'select', options: ['L', 'P'] },
                { key: 'jabatan_struktural', label: 'Jabatan', table: 'pegawai', editable: true },
                { key: 'no_hp', label: 'No HP', table: 'orang', editable: true },
                { key: 'status_kepegawaian', label: 'Status', table: 'pegawai', editable: false }
            ]
        }
    };

    // --- FUNGSI UTAMA ---

    async function loadData() {
        showLoading("Sedang mengambil data...");
        const config = SCHEMA[currentTab];
        
        renderHeader(config.columns);

        const { data, error } = await dbConnection
            .from(config.view)
            .select('*')
            .order(config.columns[0].key, { ascending: true });

        if (error) {
            console.error(error);
            showError("Error Database: " + error.message + " (Cek Console F12)");
        } else {
            tableData = data;
            renderBody(data);
            showSuccess(`Berhasil memuat ${data.length} data ${currentTab}.`);
        }
    }

    function renderHeader(columns) {
        const thead = document.getElementById('tableHead');
        let html = '<tr>';
        columns.forEach(col => html += `<th>${col.label}</th>`);
        html += '</tr>';
        thead.innerHTML = html;
    }

    function renderBody(data) {
        const tbody = document.getElementById('tableBody');
        const config = SCHEMA[currentTab];
        tbody.innerHTML = '';

        if(data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:20px;">Data Kosong. Klik "Edit Mode" lalu "Tambah Baris".</td></tr>';
            return;
        }

        data.forEach((row) => {
            const tr = document.createElement('tr');
            tr.dataset.rowId = row[config.primary_key]; 
            tr.dataset.orangId = row['orang_id'];

            let html = '';
            config.columns.forEach(col => {
                const value = row[col.key] || '';
                if (isEditMode && col.editable) {
                    if (col.type === 'select') {
                        let options = col.options.map(opt => `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt}</option>`).join('');
                        html += `<td><select class="input-cell" data-col="${col.key}">${options}</select></td>`;
                    } else {
                        html += `<td><input class="input-cell" type="text" value="${value}" data-col="${col.key}"></td>`;
                    }
                } else {
                    html += `<td>${value}</td>`;
                }
            });
            tr.innerHTML = html;
            tbody.appendChild(tr);
        });
    }

    // --- INTERAKSI UI ---

    function switchTab(tabName) {
        currentTab = tabName;
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        const activeTab = Array.from(document.querySelectorAll('.tab')).find(el => el.innerText.toLowerCase().includes(tabName));
        if(activeTab) activeTab.classList.add('active');
        isEditMode = false;
        updateButtons();
        loadData();
    }

    function toggleEditMode() {
        isEditMode = !isEditMode;
        updateButtons();
        renderBody(tableData);
        if (isEditMode && tableData.length === 0) addNewRow();
    }

    function updateButtons() {
        const btnEdit = document.getElementById('btnToggleEdit');
        const btnSave = document.getElementById('btnSave');
        const btnAdd = document.getElementById('btnAddRow');

        if (isEditMode) {
            btnEdit.classList.add('hidden');
            btnSave.classList.remove('hidden');
            btnAdd.classList.remove('hidden');
        } else {
            btnEdit.classList.remove('hidden');
            btnEdit.innerText = "‚úèÔ∏è Edit Mode";
            btnSave.classList.add('hidden');
            btnAdd.classList.add('hidden');
            document.querySelectorAll('.new-row').forEach(row => row.remove());
        }
    }

    function addNewRow() {
        const tbody = document.getElementById('tableBody');
        if(tbody.innerText.includes('Data Kosong')) tbody.innerHTML = '';

        const config = SCHEMA[currentTab];
        const tr = document.createElement('tr');
        tr.classList.add('new-row');
        
        let html = '';
        config.columns.forEach(col => {
            if (col.editable) {
                if(col.type === 'select'){
                    let options = col.options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                    html += `<td><select class="input-cell" data-col="${col.key}">${options}</select></td>`;
                } else {
                    html += `<td><input class="input-cell" type="text" placeholder="..." data-col="${col.key}"></td>`;
                }
            } else {
                html += `<td>-</td>`;
            }
        });
        tr.innerHTML = html;
        tbody.insertBefore(tr, tbody.firstChild);
    }

    async function saveAllChanges() {
        showLoading("Menyimpan perubahan...");
        const config = SCHEMA[currentTab];
        const rows = document.querySelectorAll('#tableBody tr');
        let successCount = 0;

        try {
            for (let tr of rows) {
                // INSERT
                if (tr.classList.contains('new-row')) {
                    const newData = {};
                    tr.querySelectorAll('.input-cell').forEach(input => newData[input.dataset.col] = input.value);
                    
                    let rpcParams = (currentTab === 'santri') 
                        ? { p_nama: newData.nama_lengkap, p_gender: newData.jenis_kelamin, p_hp: newData.no_hp, p_nis: newData.nis, p_tahun_masuk: 2024, p_kelas: newData.kelas_saat_ini }
                        : { p_nama: newData.nama_lengkap, p_gender: newData.jenis_kelamin, p_hp: newData.no_hp, p_nip: newData.nip, p_jabatan: newData.jabatan_struktural };

                    const { error } = await dbConnection.rpc(config.rpc_insert, rpcParams);
                    if (error) throw error;
                    successCount++;
                } 
                // UPDATE
                else if (tr.dataset.rowId) {
                    const rowId = tr.dataset.rowId;
                    const orangId = tr.dataset.orangId;
                    const inputs = tr.querySelectorAll('.input-cell');
                    
                    for (let input of inputs) {
                        const colKey = input.dataset.col;
                        const colConfig = config.columns.find(c => c.key === colKey);
                        let targetTable = colConfig.table;
                        let targetId = (targetTable === 'orang') ? orangId : rowId;

                        const { error } = await dbConnection.from(targetTable).update({ [colKey]: input.value }).eq('id', targetId);
                        if (error) throw error;
                    }
                    successCount++;
                }
            }
            showSuccess("Data berhasil disimpan!");
            isEditMode = false;
            updateButtons();
            loadData();
        } catch (err) {
            showError("Gagal Simpan: " + err.message);
        }
    }

    // Helpers untuk Status Bar
    function showLoading(msg) {
        const box = document.getElementById('statusBox');
        box.style.display = 'block';
        box.className = 'status-box status-loading';
        box.innerText = '‚è≥ ' + msg;
    }
    function showSuccess(msg) {
        const box = document.getElementById('statusBox');
        box.style.display = 'block';
        box.className = 'status-box status-success';
        box.innerText = '‚úÖ ' + msg;
        setTimeout(() => { box.style.display = 'none'; }, 3000);
    }
    function showError(msg) {
        const box = document.getElementById('statusBox');
        box.style.display = 'block';
        box.className = 'status-box status-error';
        box.innerText = '‚ùå ' + msg;
    }

    // JALANKAN APLIKASI
    initApp();

</script>
</body>
</html>
